<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Math Running</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

```
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
    }
    
    html, body {
        width: 100%;
        height: 100vh;
        height: 100dvh;
        overflow: hidden;
        position: fixed;
        overscroll-behavior: none;
    }
    
    body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        touch-action: none;
    }
    
    #gameCanvas {
        display: block;
        touch-action: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    #ui {
        position: fixed;
        top: 180px;
        left: 20px;
        color: white;
        font-size: 14px;
        z-index: 10;
        background: rgba(15, 23, 42, 0.9);
        padding: 12px 16px;
        border-radius: 4px;
        border-left: 4px solid #ef4444;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    #ui > div {
        margin: 4px 0;
        font-weight: 600;
        letter-spacing: 0.5px;
        font-size: 14px;
    }
    
    #ui span {
        color: #ffffff;
        font-weight: 700;
        font-size: 16px;
    }
    
    #timer {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #1e293b;
        font-size: clamp(48px, 12vw, 80px);
        font-weight: 700;
        z-index: 5;
        font-family: 'Courier New', monospace;
        letter-spacing: 2px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: color 0.3s ease;
    }
    
    #timer.time-add {
        animation: flashGreen 0.3s ease;
    }
    
    #timer.time-sub {
        animation: flashRed 0.3s ease;
    }
    
    @keyframes flashGreen {
        0%, 100% { color: #1e293b; }
        50% { color: #10b981; text-shadow: 0 0 20px rgba(16, 185, 129, 0.6); }
    }
    
    @keyframes flashRed {
        0%, 100% { color: #1e293b; }
        50% { color: #ef4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.6); }
    }
    
    #questionDisplay {
        position: fixed;
        top: 300px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(15, 23, 42, 0.95);
        padding: 20px 30px;
        color: white;
        text-align: center;
        z-index: 15;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        min-width: 260px;
        max-width: 90%;
        border: 2px solid rgba(239, 68, 68, 0.3);
        border-radius: 4px;
    }
    
    #questionDisplay h2 {
        color: #ffffff;
        font-size: clamp(20px, 5vw, 32px);
        margin-bottom: 12px;
        font-weight: 700;
        letter-spacing: 1px;
    }
    
    #currentAnswer {
        color: #ef4444;
        font-size: clamp(22px, 5.5vw, 28px);
        min-width: 100px;
        display: inline-block;
        border-bottom: 3px solid #ef4444;
        padding: 6px 12px;
        font-weight: 700;
        letter-spacing: 4px;
        font-family: 'Courier New', monospace;
    }
    
    #warningCountdown {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 251, 235, 0.95);
        backdrop-filter: blur(15px);
        border: 3px solid #f59e0b;
        border-radius: 8px;
        padding: 12px 24px;
        color: #d97706;
        font-size: clamp(24px, 6vw, 36px);
        font-weight: 700;
        text-align: center;
        display: none;
        z-index: 60;
        box-shadow: 0 8px 32px rgba(245, 158, 11, 0.25);
    }
    
    #keyboard {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(4, 1fr);
        gap: 8px;
        z-index: 10;
        max-width: 300px;
        width: calc(100% - 20px);
        padding: 0 10px;
    }
    
    .key-btn {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(99, 102, 241, 0.2);
        border-radius: 14px;
        color: #4f46e5;
        font-size: clamp(22px, 5.5vw, 30px);
        font-weight: 700;
        padding: clamp(16px, 4.5vw, 22px);
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: none;
        transition: all 0.2s ease;
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.1);
        cursor: pointer;
        aspect-ratio: 1;
    }
    
    .key-btn:active {
        background: rgba(238, 242, 255, 1);
        transform: scale(0.95);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
    }
    
    .key-btn.disabled {
        background: rgba(241, 245, 249, 0.7);
        border-color: rgba(148, 163, 184, 0.2);
        color: rgba(148, 163, 184, 0.4);
        pointer-events: none;
        box-shadow: none;
    }
    
    .key-btn.required {
        animation: requiredPulse 0.6s infinite;
        border-color: #ef4444;
        background: rgba(254, 242, 242, 0.95);
        color: #dc2626;
        box-shadow: 0 0 24px rgba(239, 68, 68, 0.3), 0 4px 16px rgba(239, 68, 68, 0.2);
    }
    
    @keyframes requiredPulse {
        0%, 100% { 
            background: rgba(254, 242, 242, 0.95);
            transform: scale(1);
        }
        50% { 
            background: rgba(254, 226, 226, 1);
            transform: scale(1.08);
        }
    }
    
    .key-btn.forbidden {
        animation: forbiddenShake 0.4s infinite;
        border-color: #f59e0b;
        background: rgba(255, 251, 235, 0.95);
        color: #d97706;
        box-shadow: 0 0 24px rgba(245, 158, 11, 0.2);
    }
    
    @keyframes forbiddenShake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        75% { transform: translateX(4px); }
    }
    
    .special-key {
        background: rgba(99, 102, 241, 0.1);
        border-color: rgba(99, 102, 241, 0.3);
        color: #4f46e5;
        font-size: clamp(14px, 3.5vw, 18px);
    }
    
    .special-key:active {
        background: rgba(99, 102, 241, 0.2);
    }
    
    #stageSelect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0f172a;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 200;
        padding: 20px;
    }
    
    #stageSelect h1 {
        color: #ffffff;
        font-size: clamp(36px, 10vw, 56px);
        margin-bottom: 24px;
        font-weight: 700;
        letter-spacing: 2px;
    }
    
    .enemy-preview {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 40px;
        max-width: 400px;
        width: 90%;
    }
    
    .enemy-preview h3 {
        color: #ef4444;
        font-size: clamp(16px, 4vw, 20px);
        margin-bottom: 12px;
    }
    
    .enemy-preview-image {
        background: rgba(239, 68, 68, 0.2);
        border: 2px solid #ef4444;
        border-radius: 8px;
        padding: 16px;
        margin: 12px 0;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .key-preview {
        background: rgba(254, 242, 242, 0.95);
        border: 2px solid #ef4444;
        border-radius: 8px;
        padding: 12px 16px;
        color: #dc2626;
        font-size: 20px;
        font-weight: 700;
        min-width: 50px;
        text-align: center;
        animation: requiredPulse 0.6s infinite;
    }
    
    .enemy-desc {
        color: #94a3b8;
        font-size: clamp(13px, 3vw, 15px);
        line-height: 1.6;
    }
    
    .start-btn {
        background: #ef4444;
        border: none;
        border-radius: 4px;
        padding: 20px 60px;
        color: white;
        font-size: clamp(18px, 4vw, 24px);
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 0 #991b1b;
        letter-spacing: 1px;
    }
    
    .start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 0 #991b1b;
    }
    
    .start-btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #991b1b;
    }
    
    #prepCountdown {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0f172a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 250;
    }
    
    #prepCountdown .count {
        color: #ef4444;
        font-size: clamp(80px, 20vw, 160px);
        font-weight: 700;
        animation: prepPulse 1s ease-in-out;
    }
    
    @keyframes prepPulse {
        0% { 
            transform: scale(0.5);
            opacity: 0;
        }
        50% {
            transform: scale(1.2);
        }
        100% { 
            transform: scale(1);
            opacity: 1;
        }
    }
    
    #floorTransition {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0f172a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 250;
        padding: 20px;
    }
    
    #floorTransition h2 {
        color: #ffffff;
        font-size: clamp(28px, 8vw, 48px);
        margin-bottom: 30px;
        font-weight: 700;
    }
    
    #floorTransition .new-enemy-info {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 40px;
        max-width: 500px;
        width: 90%;
    }
    
    #floorTransition .new-enemy-info h3 {
        color: #f59e0b;
        font-size: clamp(18px, 5vw, 24px);
        margin-bottom: 16px;
    }
    
    .forbidden-preview {
        background: rgba(255, 251, 235, 0.2);
        border: 2px solid #f59e0b;
        border-radius: 8px;
        padding: 16px;
        margin: 12px 0;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .key-forbidden {
        background: rgba(255, 251, 235, 0.95);
        border: 2px solid #f59e0b;
        border-radius: 8px;
        padding: 12px 16px;
        color: #d97706;
        font-size: 20px;
        font-weight: 700;
        min-width: 50px;
        text-align: center;
        animation: forbiddenShake 0.4s infinite;
    }
    
    .continue-btn {
        background: #10b981;
        border: none;
        border-radius: 4px;
        padding: 18px 50px;
        color: white;
        font-size: clamp(16px, 4vw, 22px);
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 0 #047857;
        letter-spacing: 1px;
    }
    
    .continue-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 0 #047857;
    }
    
    .continue-btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #047857;
    }
    
    #gameOver {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border: 4px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        padding: 32px;
        color: #1e293b;
        text-align: center;
        display: none;
        z-index: 101;
        max-width: 90%;
        box-shadow: 0 16px 64px rgba(239, 68, 68, 0.15);
    }
    
    #gameOver h1 {
        color: #ef4444;
        font-size: clamp(28px, 8vw, 42px);
        margin-bottom: 20px;
        font-weight: 700;
    }
    
    #gameOver p {
        font-size: clamp(14px, 4vw, 18px);
        margin: 12px 0;
        font-weight: 600;
        color: #475569;
    }
    
    #gameOver button {
        font-size: clamp(16px, 4vw, 20px);
        font-weight: 700;
        padding: 14px 40px;
        margin-top: 24px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
    }
    
    #gameOver button:active {
        transform: scale(0.95);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
    }
</style>
```

</head>
<body>
    <div id="stageSelect">
        <h1>MATH RUNNING</h1>

```
    <div class="enemy-preview">
        <h3>üî¥ Ëµ§„ÅÑÊïµ</h3>
        <div class="enemy-preview-image">
            <div class="key-preview">5</div>
        </div>
        <div class="enemy-desc">
            ÊåáÂÆö„Åï„Çå„ÅüÊï∞Â≠ó„Ç≠„Éº„ÅåÂÖâ„Çä„Åæ„Åô„ÄÇ<br>
            „Åù„ÅÆÊï∞Â≠ó„ÇíÊäº„Åï„Å™„ÅÑ„Å®„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅ
        </div>
    </div>
    
    <button class="start-btn" id="startGameBtn">START</button>
</div>

<div id="prepCountdown">
    <div class="count"></div>
</div>

<div id="floorTransition">
    <h2>ÈöéÂ±§ <span id="newFloorNum"></span></h2>
    <div class="new-enemy-info">
        <h3>üü° Êñ∞„Åó„ÅÑÊïµ„ÅåÁôªÂ†¥ÔºÅ</h3>
        <div class="forbidden-preview" id="newEnemyPreview"></div>
        <div class="enemy-desc" id="newEnemyDesc"></div>
    </div>
    <button class="continue-btn" id="continueBtn">Ê¨°„ÅÆÈöéÂ±§„Å∏</button>
</div>

<canvas id="gameCanvas"></canvas>

<div id="ui">
    <div>ÈöéÂ±§: <span id="floor">1</span></div>
    <div>ÂïèÈ°å: <span id="questionNum">0</span> / 10</div>
    <div>„Çπ„Ç≥„Ç¢: <span id="score">0</span></div>
</div>

<div id="timer">45.00</div>

<div id="warningCountdown">‚ö†Ô∏è <span id="countdownNum"></span></div>

<div id="questionDisplay">
    <h2 id="questionText">Ê∫ñÂÇô‰∏≠...</h2>
    <div>
        <span id="currentAnswer">_</span>
    </div>
</div>

<div id="keyboard">
    <button class="key-btn" data-num="1">1</button>
    <button class="key-btn" data-num="2">2</button>
    <button class="key-btn" data-num="3">3</button>
    <button class="key-btn" data-num="4">4</button>
    <button class="key-btn" data-num="5">5</button>
    <button class="key-btn" data-num="6">6</button>
    <button class="key-btn" data-num="7">7</button>
    <button class="key-btn" data-num="8">8</button>
    <button class="key-btn" data-num="9">9</button>
    <button class="key-btn special-key" id="backspaceBtn">ÂâäÈô§</button>
    <button class="key-btn" data-num="0">0</button>
    <button class="key-btn special-key" id="submitBtn">Ê±∫ÂÆö</button>
</div>

<div id="gameOver">
    <h1>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</h1>
    <p id="deathReason"></p>
    <p>Âà∞ÈÅîÈöéÂ±§: <span id="finalFloor"></span></p>
    <p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="finalScore"></span></p>
    <button id="restartBtn">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
</div>

<script>
    // „Éï„É´„Çπ„ÇØ„É™„Éº„É≥Ë¶ÅÊ±Ç
    function requestFullscreen() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen().catch(() => {});
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
        } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
        }
    }
    
    // „Ç¢„Éâ„É¨„Çπ„Éê„Éº„ÇíÈö†„Åô
    window.addEventListener('load', () => {
        setTimeout(() => {
            window.scrollTo(0, 1);
        }, 0);
    });
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // „Ç≤„Éº„É†Áä∂ÊÖã
    const game = {
        score: 0,
        questionNum: 0,
        floor: 1,
        questionsPerFloor: 10,
        isGameOver: false,
        timeLeft: 45.00,
        baseTime: 45.00,
        correctAnswers: 0,
        totalQuestions: 0,
        currentAnswer: '',
        currentQuestion: null
    };
    
    // Êïµ„Çø„Ç§„Éó
    const enemyTypes = {
        RED: {
            name: 'Ëµ§„ÅÑÊïµ',
            color: '#ef4444',
            effect: 'REQUIRE_KEY',
            duration: 180
        },
        YELLOW: {
            name: 'ÈªÑËâ≤„ÅÑÊïµ',
            color: '#f59e0b',
            effect: 'FORBID_KEYS',
            duration: 60  // 1Áßí„Å´Áü≠Á∏Æ
        }
    };
    
    let currentEffect = null;
    let effectTimer = 0;
    let requiredKey = null;
    let countdownActive = false;
    let countdownTimer = 0;
    let countdownSeconds = 0;
    
    // Èõ£ÊòìÂ∫¶Ë®≠ÂÆöÔºàÈöéÂ±§„Å´„Çà„ÇãÔºâ- È´òÊ†°„É¨„Éô„É´
    function getDifficulty() {
        const floor = game.floor;
        let config = {
            maxNum: 100,
            multiplyMax: 12,
            operations: ['+', '-', '√ó', '√∑'],
            advanced: []
        };
        
        // ÈöéÂ±§1: Âü∫Êú¨ÂõõÂâáÊºîÁÆó
        if (floor === 1) {
            config.maxNum = 50;
            config.multiplyMax = 12;
            config.operations = ['+', '-', '√ó', '√∑'];
        }
        // ÈöéÂ±§2: Âπ≥ÊñπÊ†πËøΩÂä†
        else if (floor === 2) {
            config.maxNum = 100;
            config.multiplyMax = 15;
            config.operations = ['+', '-', '√ó', '√∑', '‚àö'];
        }
        // ÈöéÂ±§3: Á¥Ø‰πóËøΩÂä†
        else if (floor === 3) {
            config.maxNum = 50;
            config.multiplyMax = 12;
            config.operations = ['+', '-', '√ó', '√∑', '‚àö', '^'];
        }
        // ÈöéÂ±§4: Âõ†Êï∞ÂàÜËß£ÁöÑ„Å™ÂïèÈ°å
        else if (floor === 4) {
            config.maxNum = 100;
            config.multiplyMax = 15;
            config.operations = ['+', '-', '√ó', '√∑', '‚àö', '^', 'factor'];
        }
        // ÈöéÂ±§5‰ª•Èôç: „Åô„Åπ„Å¶Ê∑∑Âêà„ÄÅÈõ£ÊòìÂ∫¶‰∏äÊòá
        else {
            config.maxNum = Math.min(200 + floor * 50, 1000);
            config.multiplyMax = Math.min(15 + floor, 25);
            config.operations = ['+', '-', '√ó', '√∑', '‚àö', '^', 'factor'];
        }
        
        return config;
    }
    
    // ÂïèÈ°åÁîüÊàê - È´òÊ†°„É¨„Éô„É´
    function generateQuestion() {
        const config = getDifficulty();
        const operations = config.operations;
        const op = operations[Math.floor(Math.random() * operations.length)];
        let num1, num2, answer, questionText;
        
        const maxNum = config.maxNum;
        
        switch(op) {
            case '+':
                num1 = Math.floor(Math.random() * maxNum) + 10;
                num2 = Math.floor(Math.random() * maxNum) + 10;
                answer = num1 + num2;
                questionText = `${num1} + ${num2} = ?`;
                break;
                
            case '-':
                num1 = Math.floor(Math.random() * maxNum) + maxNum;
                num2 = Math.floor(Math.random() * num1) + 10;
                answer = num1 - num2;
                questionText = `${num1} - ${num2} = ?`;
                break;
                
            case '√ó':
                num1 = Math.floor(Math.random() * config.multiplyMax) + 2;
                num2 = Math.floor(Math.random() * config.multiplyMax) + 2;
                answer = num1 * num2;
                questionText = `${num1} √ó ${num2} = ?`;
                break;
                
            case '√∑':
                num2 = Math.floor(Math.random() * config.multiplyMax) + 2;
                answer = Math.floor(Math.random() * config.multiplyMax) + 2;
                num1 = num2 * answer;
                questionText = `${num1} √∑ ${num2} = ?`;
                break;
                
            case '‚àö':
                // ÂÆåÂÖ®Âπ≥ÊñπÊï∞„ÅÆ„É´„Éº„Éà
                const base = Math.floor(Math.random() * 15) + 2;
                num1 = base * base;
                answer = base;
                questionText = `‚àö${num1} = ?`;
                break;
                
            case '^':
                // Á¥Ø‰πóË®àÁÆó
                const baseNum = Math.floor(Math.random() * 10) + 2;
                const exponent = Math.floor(Math.random() * 3) + 2; // 2‰πó„Åã3‰πó
                answer = Math.pow(baseNum, exponent);
                questionText = `${baseNum}^${exponent} = ?`;
                break;
                
            case 'factor':
                // Âõ†Êï∞ÂàÜËß£ÁöÑ: a√ób „ÅÆÂΩ¢„Åß a „ÇíÊ±Ç„ÇÅ„Çã
                const factor1 = Math.floor(Math.random() * 12) + 3;
                const factor2 = Math.floor(Math.random() * 12) + 3;
                const product = factor1 * factor2;
                answer = factor1;
                questionText = `${product} = ? √ó ${factor2}`;
                break;
                
            default:
                // „Éá„Éï„Ç©„É´„Éà„ÅØÂä†ÁÆó
                num1 = Math.floor(Math.random() * maxNum) + 1;
                num2 = Math.floor(Math.random() * maxNum) + 1;
                answer = num1 + num2;
                questionText = `${num1} + ${num2} = ?`;
        }
        
        return {
            text: questionText,
            answer: answer
        };
    }
    
    // Êñ∞„Åó„ÅÑÂïèÈ°å
    function newQuestion() {
        game.currentQuestion = generateQuestion();
        game.currentAnswer = '';
        document.getElementById('questionText').textContent = game.currentQuestion.text;
        document.getElementById('currentAnswer').textContent = '_';
    }
    
    // ËÉåÊôØÊèèÁîª
    function drawBackground() {
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#f5f7fa');
        gradient.addColorStop(0.5, '#c3cfe2');
        gradient.addColorStop(1, '#e0e7ff');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.strokeStyle = 'rgba(99, 102, 241, 0.08)';
        ctx.lineWidth = 1.5;
        const hexSize = 50;
        
        for (let y = -hexSize; y < canvas.height + hexSize; y += hexSize * 1.5) {
            for (let x = -hexSize; x < canvas.width + hexSize; x += hexSize * Math.sqrt(3)) {
                const offsetX = (Math.floor(y / (hexSize * 1.5)) % 2) * (hexSize * Math.sqrt(3) / 2);
                drawHexagon(x + offsetX, y, hexSize / 2);
            }
        }
        
        const gradient2 = ctx.createRadialGradient(
            canvas.width/2, canvas.height/2, 0,
            canvas.width/2, canvas.height/2, canvas.width * 0.7
        );
        gradient2.addColorStop(0, 'rgba(255, 255, 255, 0)');
        gradient2.addColorStop(0.7, 'rgba(99, 102, 241, 0.03)');
        gradient2.addColorStop(1, 'rgba(99, 102, 241, 0.08)');
        ctx.fillStyle = gradient2;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    function drawHexagon(x, y, size) {
        ctx.beginPath();
        for (let i = 0; i < 6; i++) {
            const angle = (Math.PI / 3) * i;
            const hx = x + size * Math.cos(angle);
            const hy = y + size * Math.sin(angle);
            if (i === 0) {
                ctx.moveTo(hx, hy);
            } else {
                ctx.lineTo(hx, hy);
            }
        }
        ctx.closePath();
        ctx.stroke();
    }
    
    // „Çø„Ç§„Éû„ÉºÊõ¥Êñ∞
    let lastTimeAdd = false;
    function updateTimer() {
        if (game.isGameOver) return;
        
        const oldTime = game.timeLeft;
        game.timeLeft -= 1/60;
        
        const timerEl = document.getElementById('timer');
        timerEl.textContent = game.timeLeft.toFixed(2);
        
        if (game.timeLeft <= 0) {
            gameOver('ÊôÇÈñìÂàá„ÇåÔºÅ');
        }
    }
    
    function flashTimer(isAdd) {
        const timerEl = document.getElementById('timer');
        timerEl.classList.remove('time-add', 'time-sub');
        void timerEl.offsetWidth; // „É™„Éï„É≠„Éº
        timerEl.classList.add(isAdd ? 'time-add' : 'time-sub');
    }
    
    // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫
    function showCountdown(enemyType) {
        countdownActive = true;
        countdownTimer = 90; // 1.5Áßí
        countdownSeconds = 2; // ÂàùÊúüË°®Á§∫
        
        const countdownEl = document.getElementById('warningCountdown');
        const numEl = document.getElementById('countdownNum');
        numEl.textContent = countdownSeconds;
        countdownEl.style.display = 'block';
        
        window.pendingEnemy = enemyType;
    }
    
    // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Êõ¥Êñ∞
    function updateCountdown() {
        if (!countdownActive) return;
        
        countdownTimer--;
        const newSeconds = Math.ceil(countdownTimer / 60);
        
        // Áßí„ÅåÂ§â„Çè„Å£„Åü„ÇâÊõ¥Êñ∞
        if (newSeconds !== countdownSeconds && newSeconds >= 0) {
            countdownSeconds = newSeconds;
            document.getElementById('countdownNum').textContent = countdownSeconds;
        }
        
        if (countdownTimer <= 0) {
            document.getElementById('warningCountdown').style.display = 'none';
            countdownActive = false;
            
            if (window.pendingEnemy) {
                activateEnemy(window.pendingEnemy);
                window.pendingEnemy = null;
            }
        }
    }
    
    // Êïµ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ
    function activateEnemy(type) {
        currentEffect = type;
        effectTimer = type.duration;
        
        switch(type.effect) {
            case 'REQUIRE_KEY':
                requiredKey = Math.floor(Math.random() * 10);
                updateKeyboardState();
                break;
            case 'FORBID_KEYS':
                updateKeyboardState();
                break;
        }
    }
    
    // „Ç≠„Éº„Éú„Éº„ÉâÁä∂ÊÖãÊõ¥Êñ∞
    function updateKeyboardState() {
        const keys = document.querySelectorAll('.key-btn');
        keys.forEach(key => {
            const num = parseInt(key.dataset.num);
            if (isNaN(num)) return;
            
            key.classList.remove('required', 'forbidden', 'disabled');
            
            if (!currentEffect) return;
            
            switch(currentEffect.effect) {
                case 'REQUIRE_KEY':
                    if (num === requiredKey) {
                        key.classList.add('required');
                    }
                    break;
                case 'FORBID_KEYS':
                    key.classList.add('forbidden');
                    break;
            }
        });
    }
    
    // „Ç®„Éï„Çß„ÇØ„ÉàÊõ¥Êñ∞
    function updateEffect() {
        if (!currentEffect) return;
        
        effectTimer--;
        
        if (effectTimer <= 0) {
            if (currentEffect.effect === 'REQUIRE_KEY') {
                gameOver(`${requiredKey}„ÇíÊäº„Åï„Å™„Åã„Å£„ÅüÔºÅ`);
                return;
            }
            
            currentEffect = null;
            requiredKey = null;
            updateKeyboardState();
        }
    }
    
    // Êïµ„Çπ„Éù„Éº„É≥
    function spawnEnemy() {
        if (game.isGameOver || countdownActive || currentEffect) return;
        
        let availableEnemies = [];
        
        if (game.floor === 1) {
            availableEnemies = [enemyTypes.RED];
        } else {
            availableEnemies = [enemyTypes.RED, enemyTypes.YELLOW];
        }
        
        const type = availableEnemies[Math.floor(Math.random() * availableEnemies.length)];
        
        if (type.effect === 'FORBID_KEYS') {
            showCountdown(type);
        } else {
            activateEnemy(type);
        }
    }
    
    let enemySpawnTimer = 0;
    function checkEnemySpawn() {
        if (game.isGameOver) return;
        
        enemySpawnTimer++;
        const spawnInterval = 180 + Math.random() * 240;
        
        if (enemySpawnTimer > spawnInterval) {
            spawnEnemy();
            enemySpawnTimer = 0;
        }
    }
    
    // „Ç≠„ÉºÂÖ•Âäõ
    document.querySelectorAll('.key-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (game.isGameOver) return;
            
            if (!btn.dataset.num) return;
            const num = parseInt(btn.dataset.num);
            
            if (currentEffect && currentEffect.effect === 'FORBID_KEYS') {
                gameOver('„Ç≠„Éº„Éú„Éº„Éâ„ÇíËß¶„Å£„Å¶„Åó„Åæ„Å£„ÅüÔºÅ');
                return;
            }
            
            if (currentEffect && currentEffect.effect === 'REQUIRE_KEY') {
                if (num === requiredKey) {
                    currentEffect = null;
                    requiredKey = null;
                    updateKeyboardState();
                    game.score += 50 * game.floor;
                    document.getElementById('score').textContent = game.score;
                    flashTimer(true);
                    return;
                }
            }
            
            if (game.currentAnswer.length < 5) {
                game.currentAnswer += num;
                document.getElementById('currentAnswer').textContent = game.currentAnswer || '_';
            }
        });
    });
    
    // Ê±∫ÂÆö„Éú„Çø„É≥
    document.getElementById('submitBtn').addEventListener('click', () => {
        if (game.isGameOver || !game.currentAnswer) return;
        
        game.totalQuestions++;
        const userAnswer = parseInt(game.currentAnswer);
        
        if (userAnswer === game.currentQuestion.answer) {
            game.correctAnswers++;
            game.score += 100 * game.floor;
            game.timeLeft = Math.min(game.timeLeft + 2, game.baseTime + 5);
            flashTimer(true);
            game.questionNum++;
            
            if (game.questionNum >= game.questionsPerFloor) {
                showFloorTransition();
                return;
            }
            
            document.getElementById('questionNum').textContent = game.questionNum;
            document.getElementById('score').textContent = game.score;
        } else {
            game.timeLeft = Math.max(game.timeLeft - 3, 0.5);
            flashTimer(false);
        }
        
        newQuestion();
    });
    
    // „Éê„ÉÉ„ÇØ„Çπ„Éö„Éº„Çπ
    document.getElementById('backspaceBtn').addEventListener('click', () => {
        if (game.currentAnswer.length > 0) {
            game.currentAnswer = game.currentAnswer.slice(0, -1);
            document.getElementById('currentAnswer').textContent = game.currentAnswer || '_';
        }
    });
    
    // ÈöéÂ±§ÈÅ∑Áßª
    function showFloorTransition() {
        game.floor++;
        game.questionNum = 0;
        game.baseTime = Math.min(45 + (game.floor - 1) * 3, 60);
        game.timeLeft = game.baseTime;
        
        const transitionEl = document.getElementById('floorTransition');
        document.getElementById('newFloorNum').textContent = game.floor;
        
        if (game.floor === 2) {
            const previewEl = document.getElementById('newEnemyPreview');
            previewEl.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const key = document.createElement('div');
                key.className = 'key-forbidden';
                key.textContent = [1,2,3,4,5,6,7,8,9][i];
                previewEl.appendChild(key);
            }
            document.getElementById('newEnemyDesc').textContent = 
                '„Ç≠„Éº„Éú„Éº„Éâ„ÅåÈªÑËâ≤„ÅèÈúá„Åà„Å¶„ÅÑ„ÇãÈñì„ÅØ„ÄÅ„Å©„ÅÆ„Ç≠„Éº„ÇÇÊäº„Åó„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„ÇìÔºÅ';
            transitionEl.style.display = 'flex';
        } else {
            continueToNextFloor();
        }
    }
    
    function continueToNextFloor() {
        document.getElementById('floorTransition').style.display = 'none';
        document.getElementById('floor').textContent = game.floor;
        document.getElementById('questionNum').textContent = game.questionNum;
        newQuestion();
    }
    
    document.getElementById('continueBtn').addEventListener('click', continueToNextFloor);
    
    // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
    function gameOver(reason) {
        if (game.isGameOver) return;
        game.isGameOver = true;
        document.getElementById('deathReason').textContent = reason;
        document.getElementById('finalFloor').textContent = game.floor;
        document.getElementById('finalScore').textContent = game.score;
        document.getElementById('gameOver').style.display = 'block';
    }
    
    document.getElementById('restartBtn').onclick = () => location.reload();
    
    // „Ç≤„Éº„É†ÈñãÂßã
    function startGame() {
        requestFullscreen();
        document.getElementById('stageSelect').style.display = 'none';
        showPrepCountdown();
    }
    
    function showPrepCountdown() {
        const prepEl = document.getElementById('prepCountdown');
        const countEl = prepEl.querySelector('.count');
        prepEl.style.display = 'flex';
        
        let count = 3;
        countEl.textContent = count;
        
        const interval = setInterval(() => {
            count--;
            if (count > 0) {
                countEl.textContent = count;
            } else {
                countEl.textContent = 'START!';
                setTimeout(() => {
                    prepEl.style.display = 'none';
                    newQuestion();
                    gameLoop();
                }, 500);
                clearInterval(interval);
            }
        }, 1000);
    }
    
    document.getElementById('startGameBtn').addEventListener('click', startGame);
    
    // „Ç≤„Éº„É†„É´„Éº„Éó
    function gameLoop() {
        if (!game.isGameOver) {
            drawBackground();
            updateTimer();
            updateEffect();
            updateCountdown();
            checkEnemySpawn();
        }
        requestAnimationFrame(gameLoop);
    }
</script>
```

</body>
</html>
