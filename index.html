<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>é–¢æ•°ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f5f3ed;
            --bg-paper: #fffef9;
            --text-primary: #2d2d2d;
            --text-secondary: #6b6b6b;
            --accent-main: #d97757;
            --accent-sub: #8b7355;
            --card-plus: #e8dcc4;
            --card-substitute: #d4c5a9;
            --card-inverse: #c9b896;
            --card-derivative: #b8d4c9;
            --card-integral: #d4c9d4;
            --card-multiply: #c9c9b8;
            --card-sinify: #c9d4b8;
            --card-expify: #d4b8c9;
            --card-logify: #b8c9c9;
            --card-limit: #d4b8b8;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-main);
            margin-bottom: 20px;
            letter-spacing: 0.1em;
        }

        .header-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
        }

        .btn-back, .btn-retry, .btn-help {
            padding: 10px 24px;
            font-size: 0.9rem;
            font-weight: 500;
            background: var(--bg-paper);
            color: var(--text-primary);
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.05em;
            box-shadow: 0 2px 6px var(--shadow-light);
        }

        .btn-back:hover, .btn-retry:hover, .btn-help:hover {
            background: var(--bg-primary);
            transform: translateY(-2px);
        }

        .btn-retry {
            background: linear-gradient(135deg, var(--accent-main), #e89577);
            color: white;
            border: none;
        }

        .btn-retry:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(217, 119, 87, 0.4);
        }

        .btn-help {
            background: linear-gradient(135deg, var(--accent-sub), #a08565);
            color: white;
            border: none;
        }

        .btn-help:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(139, 115, 85, 0.4);
        }

        .battle-area {
            background: var(--bg-paper);
            border-radius: 8px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px var(--shadow-light);
            transition: box-shadow 0.3s ease;
        }

        .battle-area.active {
            animation: battleGlow 0.6s ease-in-out;
        }

        @keyframes battleGlow {
            0%, 100% {
                box-shadow: 0 2px 8px var(--shadow-light);
            }
            50% {
                box-shadow: 0 0 20px rgba(217, 119, 87, 0.3);
            }
        }

        .function-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .function-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 15px;
            letter-spacing: 0.05em;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .clear-condition {
            font-size: 0.85rem;
            color: var(--accent-main);
            font-weight: 600;
        }

        .function-formula {
            font-size: 2.5rem;
            font-weight: 400;
            color: var(--text-primary);
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        .function-formula.changing {
            animation: functionChange 0.6s ease-in-out;
        }

        @keyframes functionChange {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            25% {
                transform: scale(1.1);
                opacity: 0.7;
                color: var(--accent-main);
            }
            50% {
                transform: scale(0.95);
                opacity: 0.5;
            }
            75% {
                transform: scale(1.05);
                opacity: 0.8;
                color: var(--accent-main);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .turn-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--bg-primary);
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
        }

        .turn-count {
            color: var(--accent-main);
            font-weight: 700;
            font-size: 1.2rem;
        }

        .hand-area {
            margin-bottom: 30px;
        }

        .hand-label {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
        }

        .card-container {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            min-height: 180px;
            padding: 20px;
        }

        .card {
            width: 140px;
            height: 190px;
            background: var(--card-plus);
            border-radius: 6px;
            padding: 20px 16px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            border: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            box-shadow: 0 2px 6px var(--shadow-light);
        }

        .card.new-card {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-80px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        .card.selected {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(217, 119, 87, 0.5);
            border: 3px solid var(--accent-main);
            outline: 2px solid rgba(217, 119, 87, 0.3);
            outline-offset: 2px;
        }

        .card.substitute {
            background: var(--card-substitute);
        }

        .card.inverse {
            background: var(--card-inverse);
        }

        .card.derivative {
            background: var(--card-derivative);
        }

        .card.integral {
            background: var(--card-integral);
        }

        .card.multiply {
            background: var(--card-multiply);
        }

        .card.sinify {
            background: var(--card-sinify);
        }

        .card.expify {
            background: var(--card-expify);
        }

        .card.logify {
            background: var(--card-logify);
        }

        .card.limit {
            background: var(--card-limit);
        }

        .card-level {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 26px;
            height: 26px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--accent-main);
            border: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        .card-level.silver {
            background: linear-gradient(135deg, #f5f5f5, #c0c0c0);
            border: 2px solid #a8a8a8;
            color: #5a5a5a;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(192, 192, 192, 0.4);
        }

        .card-level.gold {
            background: linear-gradient(135deg, #fff9e6, #ffd700);
            border: 2px solid #d4af37;
            color: #8b6914;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(212, 175, 55, 0.5);
        }

        .card-effect {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            color: var(--text-primary);
            margin: auto 0;
            letter-spacing: 0.02em;
        }

        .card-name {
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .card-description {
            font-size: 0.75rem;
            text-align: center;
            color: var(--text-secondary);
            line-height: 1.3;
            margin-top: auto;
        }

        .actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 28px;
            font-size: 0.95rem;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.05em;
            box-shadow: 0 2px 6px var(--shadow-light);
        }

        .btn-use {
            background: var(--accent-main);
            color: white;
        }

        .btn-use:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-medium);
        }

        .btn-merge {
            background: var(--accent-sub);
            color: white;
        }

        .btn-merge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-medium);
        }

        .btn-end {
            background: var(--bg-paper);
            color: var(--text-primary);
            border: 1px solid rgba(0, 0, 0, 0.15);
        }

        .btn-end:hover {
            background: var(--bg-primary);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .merge-mode-indicator {
            text-align: center;
            padding: 12px;
            background: #fff4e6;
            border: 1px solid var(--accent-main);
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--accent-main);
        }

        .log {
            background: var(--bg-paper);
            border-radius: 6px;
            padding: 20px;
            max-height: 180px;
            overflow-y: auto;
            box-shadow: 0 2px 6px var(--shadow-light);
        }

        .log-title {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
        }

        .log-entry {
            padding: 6px 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-paper);
            padding: 50px 40px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .modal-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--accent-main);
        }

        .modal-content.defeat h2 {
            color: var(--text-secondary);
        }

        .modal-content p {
            font-size: 1.1rem;
            margin-bottom: 30px;
            color: var(--text-secondary);
        }

        /* ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 768px) {
            #card-detail-modal .modal-content {
                padding: 25px 18px;
                width: 95%;
                max-width: 95%;
                max-height: 88vh;
            }
            
            #card-detail-modal h2 {
                font-size: 1.25rem !important;
            }
            
            #card-detail-modal h3 {
                font-size: 1.05rem !important;
            }
            
            #card-detail-modal p {
                font-size: 0.95rem !important;
                line-height: 1.7 !important;
            }
            
            #explanation-mode-banner {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            #explanation-mode-banner button {
                margin-left: 10px;
                padding: 6px 12px;
                font-size: 0.85rem;
            }
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠç”»é¢ */
        .stage-select-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .stage-select-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-main);
            margin-bottom: 60px;
            letter-spacing: 0.15em;
        }

        .stage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            max-width: 1000px;
            width: 100%;
        }

        .stage-card {
            background: var(--bg-paper);
            border-radius: 8px;
            padding: 32px 28px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .stage-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px var(--shadow-medium);
        }

        .stage-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-main);
            margin-bottom: 12px;
            letter-spacing: 0.05em;
        }

        .stage-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .stage-description {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .stage-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .game-screen {
            display: none;
        }

        .game-screen.active {
            display: block;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 15px 10px;
            }

            .title { 
                font-size: 1.3rem;
                margin-bottom: 10px;
            }

            .header-actions {
                margin-bottom: 15px;
            }

            .btn-back {
                padding: 8px 16px;
                font-size: 0.85rem;
            }

            .battle-area {
                padding: 20px 15px;
                margin-bottom: 15px;
            }

            .function-label {
                font-size: 0.8rem;
                margin-bottom: 10px;
                gap: 5px;
            }

            .clear-condition {
                font-size: 0.75rem;
            }

            .function-formula { 
                font-size: 1.8rem;
            }

            .turn-info {
                padding: 12px 15px;
                font-size: 0.9rem;
            }

            .turn-count {
                font-size: 1.2rem;
            }

            .hand-label {
                font-size: 0.9rem;
                margin-bottom: 12px;
            }

            .card-container {
                gap: 8px;
                padding: 10px 5px;
                min-height: 150px;
            }

            .card { 
                width: 110px;
                height: 155px;
                padding: 14px 10px;
            }

            .card-name {
                font-size: 0.75rem;
                margin-bottom: 6px;
            }

            .card-effect {
                font-size: 1.4rem;
                margin: 8px 0;
            }

            .card-description {
                font-size: 0.65rem;
            }

            .card-level {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
                top: 8px;
                right: 8px;
            }

            .merge-mode-indicator {
                padding: 10px;
                margin-bottom: 12px;
                font-size: 0.85rem;
            }

            .btn { 
                padding: 11px 20px;
                font-size: 0.9rem;
                touch-action: manipulation;
            }

            .actions {
                gap: 8px;
                margin-bottom: 15px;
            }

            .log {
                padding: 12px;
                max-height: 100px;
            }

            .log-title {
                font-size: 0.85rem;
                margin-bottom: 8px;
            }

            .log-entry {
                padding: 4px 0;
                font-size: 0.75rem;
            }

            .stage-select-title {
                font-size: 2rem;
                margin-bottom: 40px;
            }

            .stage-grid {
                gap: 20px;
            }

            .stage-card {
                padding: 28px 24px;
            }
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 10px 8px;
            }

            .title {
                font-size: 1.2rem;
                margin-bottom: 8px;
            }

            .battle-area {
                padding: 15px 12px;
                margin-bottom: 12px;
            }

            .function-formula {
                font-size: 1.6rem;
            }

            .card-container {
                justify-content: center;
                gap: 6px;
                padding: 8px 5px;
                min-height: 140px;
            }

            .card {
                width: 105px;
                height: 145px;
                padding: 12px 8px;
            }

            .card-name {
                font-size: 0.7rem;
                margin-bottom: 5px;
            }

            .card-effect {
                font-size: 1.3rem;
                margin: 6px 0;
            }

            .card-description {
                font-size: 0.6rem;
            }

            .card-level {
                width: 22px;
                height: 22px;
                font-size: 0.7rem;
                top: 6px;
                right: 6px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .log {
                max-height: 80px;
                padding: 10px;
            }

            .log-title {
                font-size: 0.8rem;
                margin-bottom: 6px;
            }

            .log-entry {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠç”»é¢ -->
    <div class="stage-select-screen" id="stage-select">
        <h1 class="stage-select-title">ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ</h1>
        <div class="stage-grid">
            <div class="stage-card" onclick="startStage(1)">
                <div class="stage-number">Stage 1</div>
                <div class="stage-title">åŸºç¤æ¼”ç®— I</div>
                <div class="stage-description">x=2ã‚’ä»£å…¥ã—ã¦0ã«ã›ã‚ˆ</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜†â˜†â˜†â˜†</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 3ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage1-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(2)">
                <div class="stage-number">Stage 2</div>
                <div class="stage-title">å¾®åˆ†ã¸ã®é“</div>
                <div class="stage-description">3å›å¾®åˆ†ã—ã¦0ã«ã›ã‚ˆ</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜†â˜†â˜†â˜†</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 3ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage2-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(3)">
                <div class="stage-number">Stage 3</div>
                <div class="stage-title">æ­£ç¢ºãªä¿‚æ•°</div>
                <div class="stage-description">å¾®åˆ†ã¨å€åŒ–ã§ 4x ã‚’ä½œã‚Œ</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜†â˜†â˜†</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 3ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage3-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(4)">
                <div class="stage-number">Stage 4</div>
                <div class="stage-title">ç©åˆ†ã®ç†è§£</div>
                <div class="stage-description">ç©åˆ†ã—ã¦ã‹ã‚‰x=0ã§è©•ä¾¡</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜†â˜†â˜†</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 3ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage4-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(5)">
                <div class="stage-number">Stage 5</div>
                <div class="stage-title">è¤‡é›‘ãªå¤‰æ›</div>
                <div class="stage-description">2å›å¾®åˆ†ã—ã€ä¿‚æ•°ã‚’èª¿æ•´ã›ã‚ˆ</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜†â˜†</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 4ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage5-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(6)">
                <div class="stage-number">Stage 6</div>
                <div class="stage-title">é€†è»¢ã®ç™ºæƒ³</div>
                <div class="stage-description">ç©åˆ†ã¨å€åŒ–ã‚’é§†ä½¿ã›ã‚ˆ</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜†â˜†</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 4ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage6-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(7)">
                <div class="stage-number">Stage 7</div>
                <div class="stage-title">siné–¢æ•°ã®ç™»å ´</div>
                <div class="stage-description">siné–¢æ•°ã‚’å¾®åˆ†ã—ã€x=0ã§è©•ä¾¡</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜†â˜†</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 3ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage7-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(8)">
                <div class="stage-number">Stage 8</div>
                <div class="stage-title">æŒ‡æ•°é–¢æ•°</div>
                <div class="stage-description">lnå¤‰æ›ã—ã¦x=1ã§è©•ä¾¡</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜†</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 2ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage8-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(9)">
                <div class="stage-number">Stage 9</div>
                <div class="stage-title">ä¸‰è§’ã¨æŒ‡æ•°ã®èåˆ</div>
                <div class="stage-description">sinå¤‰æ›å¾Œã«å¾®åˆ†ã‚’ä½¿ã„ã“ãªã›</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜†</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 4ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage9-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(10)">
                <div class="stage-number">Stage 10</div>
                <div class="stage-title">ä¸‰è§’é–¢æ•°ã®å¾®åˆ†ã‚µã‚¤ã‚¯ãƒ«</div>
                <div class="stage-description">sin(x)ã‚’å¾®åˆ†ã®å¾ªç’°ã§å¤‰æ›ã›ã‚ˆ</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 5ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage10-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(11)" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.12), rgba(147, 112, 219, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(106, 90, 205, 0.2); box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.9), rgba(147, 112, 219, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(106, 90, 205, 0.3);">Stage 11</div>
                <div class="stage-title">2sin(x) + 3 ã‚’ 0 ã«</div>
                <div class="stage-description">2sin(x) + 3 ã‚’ 0 ã«å¤‰æ›</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 4ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage11-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(12)" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.12), rgba(147, 112, 219, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(106, 90, 205, 0.2); box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.9), rgba(147, 112, 219, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(106, 90, 205, 0.3);">Stage 12</div>
                <div class="stage-title">-cos(x) ã‚’ -1 ã«</div>
                <div class="stage-description">-cos(x) ã‚’ -1 ã«å¤‰æ›</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 3ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage12-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(13)" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.12), rgba(147, 112, 219, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(106, 90, 205, 0.2); box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.9), rgba(147, 112, 219, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(106, 90, 205, 0.3);">Stage 13</div>
                <div class="stage-title">e^x ã‚’ 1 ã«</div>
                <div class="stage-description">e^x ã‚’ 1 ã«å¤‰æ›</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 3ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage13-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(14)" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.12), rgba(147, 112, 219, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(106, 90, 205, 0.2); box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.9), rgba(147, 112, 219, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(106, 90, 205, 0.3);">Stage 14</div>
                <div class="stage-title">sin(x) ã‚’ 1 ã«</div>
                <div class="stage-description">sin(x) ã‚’ 1 ã«å¤‰æ›</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 4ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage14-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(15)" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.12), rgba(147, 112, 219, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(106, 90, 205, 0.2); box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.9), rgba(147, 112, 219, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(106, 90, 205, 0.3);">Stage 15</div>
                <div class="stage-title">cos(x) ã‚’ 0 ã«</div>
                <div class="stage-description">cos(x) ã‚’ 0 ã«å¤‰æ›</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 4ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage15-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(16)" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.12), rgba(147, 112, 219, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(106, 90, 205, 0.2); box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.9), rgba(147, 112, 219, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(106, 90, 205, 0.3);">Stage 16</div>
                <div class="stage-title">sin(x) + 3 ã‚’ 0 ã«</div>
                <div class="stage-description">sin(x) + 3 ã‚’ 0 ã«å¤‰æ›</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 4ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage16-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(17)" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.12), rgba(147, 112, 219, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(106, 90, 205, 0.2); box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.9), rgba(147, 112, 219, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(106, 90, 205, 0.3);">Stage 17</div>
                <div class="stage-title">e^x ã‚’ 1 ã« (å¯¾æ•°çµŒç”±)</div>
                <div class="stage-description">e^x ã‚’ 1 ã«å¤‰æ›ï¼ˆå¯¾æ•°ã‚’ä½¿ç”¨ï¼‰</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 4ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage17-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(18)" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.12), rgba(147, 112, 219, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(106, 90, 205, 0.2); box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.9), rgba(147, 112, 219, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(106, 90, 205, 0.3);">Stage 18</div>
                <div class="stage-title">cos(x) ã‚’ 1 ã«</div>
                <div class="stage-description">cos(x) ã‚’ 1 ã«å¤‰æ›</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 4ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage18-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(19)" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.12), rgba(147, 112, 219, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(106, 90, 205, 0.2); box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.9), rgba(147, 112, 219, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(106, 90, 205, 0.3);">Stage 19</div>
                <div class="stage-title">sin(x) ã‚’ 0 ã« (é€£é–)</div>
                <div class="stage-description">sin(x) ã‚’ 0 ã«å¤‰æ›ï¼ˆç©åˆ†â†’å¾®åˆ†ï¼‰</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 5ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage19-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="startStage(20)" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.12), rgba(147, 112, 219, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(106, 90, 205, 0.2); box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(106, 90, 205, 0.9), rgba(147, 112, 219, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(106, 90, 205, 0.3);">Stage 20</div>
                <div class="stage-title">cos(x) ã‚’ 0 ã« (ç·åˆ)</div>
                <div class="stage-description">cos(x) ã‚’ 0 ã«å¤‰æ›ï¼ˆå…¨æŠ€è¡“ä½¿ç”¨ï¼‰</div>
                <div class="stage-info">
                    <div>é›£æ˜“åº¦: â˜…â˜…â˜…â˜…â˜…</div>
                    <div>åˆ¶é™ã‚¿ãƒ¼ãƒ³: 6ã‚¿ãƒ¼ãƒ³</div>
                    <div id="stage20-record" style="color: var(--accent-main); font-weight: 600; margin-top: 8px;">æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦</div>
                </div>
            </div>

            <div class="stage-card" onclick="window.open('https://t4n-36.github.io/def/', '_blank')" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.12), rgba(255, 165, 0, 0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(255, 165, 0, 0.3); box-shadow: 0 4px 12px rgba(255, 165, 0, 0.2);">
                <div class="stage-number" style="background: linear-gradient(135deg, rgba(255, 165, 0, 0.9), rgba(255, 140, 0, 0.9)); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 8px rgba(255, 165, 0, 0.4);">ğŸŒŸ Extra</div>
                <div class="stage-title">è¤‡ç´ é–¢æ•°ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼</div>
                <div class="stage-description">è¤‡ç´ å¹³é¢ä¸Šã§é–¢æ•°ã‚’è¦–è¦šçš„ã«æ¢ç´¢ã—ã‚ˆã†</div>
                <div class="stage-info">
                    <div style="color: #ff8c00; font-weight: 600;">ğŸ”— å¤–éƒ¨ãƒªãƒ³ã‚¯</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">ã‚¯ãƒªãƒƒã‚¯ã§æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div class="game-screen" id="game-screen">
        <div class="game-container">
            <h1 class="title">é–¢æ•°ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </h1>

            <div class="header-actions">
                <button class="btn-back" onclick="backToStageSelect()">â† ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠã«æˆ»ã‚‹</button>
                <button class="btn-retry" onclick="retryStage()">ğŸ”„ ãƒªãƒˆãƒ©ã‚¤</button>
                <button class="btn-help" onclick="openHelpModal()">â“ ã‚«ãƒ¼ãƒ‰èª¬æ˜</button>
            </div>

            <div class="battle-area">
                <!-- ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ± -->
                <div style="text-align: center; margin-bottom: 20px; font-size: 0.9rem; color: var(--text-secondary);" id="stage-info">
                    Stage 1: åŸºç¤æ¼”ç®— I
                </div>
                
                <!-- ç›®æ¨™ã®é–¢æ•° -->
                <div class="function-display">
                    <div class="function-label">
                        <span>ç›®æ¨™ã®é–¢æ•°</span>
                        <span class="clear-condition" id="clear-condition-text">ã‚¯ãƒªã‚¢æ¡ä»¶: ã“ã®é–¢æ•°ã‚’0ã«ã™ã‚‹</span>
                    </div>
                    <div class="function-formula" id="enemy-function">g(x) = xÂ² - 6</div>
                </div>

                <!-- ã‚¿ãƒ¼ãƒ³æƒ…å ± -->
                <div class="turn-info">
                    <span>æ®‹ã‚Šã‚¿ãƒ¼ãƒ³</span>
                    <span class="turn-count" id="turn-count">5</span>
                </div>
                
                <!-- æ¬¡ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
                <div style="text-align: center; margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 6px; font-size: 0.85rem; color: var(--text-secondary);">
                    <span style="font-weight: 600;">æ¬¡ã®ã‚«ãƒ¼ãƒ‰:</span> <span id="next-card-display">-</span>
                </div>
            </div>

            <!-- åˆæˆãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º -->
            <div class="merge-mode-indicator" id="merge-indicator" style="display: none;">
                åˆæˆãƒ¢ãƒ¼ãƒ‰: åŒã˜ã‚«ãƒ¼ãƒ‰ã‚’2æšé¸æŠã—ã¦ãã ã•ã„
            </div>

            <!-- æ‰‹æœ­ -->
            <div class="hand-area">
                <div class="hand-label">æ‰‹æœ­</div>
                <div class="card-container" id="hand"></div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="actions">
                <button class="btn btn-use" id="btn-use" onclick="useCard()" disabled>ã‚«ãƒ¼ãƒ‰ä½¿ç”¨</button>
                <button class="btn btn-merge" id="btn-merge" onclick="toggleMergeMode()">ã‚«ãƒ¼ãƒ‰åˆæˆ</button>
            </div>

            <!-- ãƒ­ã‚° -->
            <div class="log">
                <div class="log-title">è¡Œå‹•ãƒ­ã‚°</div>
                <div id="log"></div>
            </div>

            <!-- å‹æ•—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div class="modal" id="modal">
                <div class="modal-content" id="modal-content">
                    <h2 id="modal-title"></h2>
                    <p id="modal-message"></p>
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-use" onclick="retryStage()">ğŸ”„ ãƒªãƒˆãƒ©ã‚¤</button>
                        <button class="btn btn-use" onclick="backToStageSelect()">ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠã«æˆ»ã‚‹</button>
                    </div>
                </div>
            </div>

            <!-- ã‚«ãƒ¼ãƒ‰è©³ç´°èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div class="modal" id="card-detail-modal">
                <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
                    <h2 id="card-detail-title" style="margin-bottom: 20px; color: var(--accent-main);"></h2>
                    <div id="card-detail-content" style="text-align: left; line-height: 1.8;">
                        <!-- å‹•çš„ã«å†…å®¹ãŒå…¥ã‚‹ -->
                    </div>
                    <button class="btn btn-use" style="margin-top: 20px;" onclick="closeCardDetailModal()">é–‰ã˜ã‚‹</button>
                </div>
            </div>

            <!-- èª¬æ˜ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º -->
            <div id="explanation-mode-banner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, var(--accent-sub), #a08565); color: white; padding: 15px; text-align: center; font-weight: 600; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                ğŸ“– ã‚«ãƒ¼ãƒ‰èª¬æ˜ãƒ¢ãƒ¼ãƒ‰ï¼šèª¬æ˜ã‚’è¦‹ãŸã„ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„
                <button onclick="exitExplanationMode()" style="margin-left: 20px; padding: 8px 16px; background: white; color: var(--accent-sub); border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">çµ‚äº†</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿
        const stageData = {
            1: {
                name: 'ä»£å…¥ã®åŸºæœ¬',
                difficulty: 1,
                enemyFunction: { coefficient: 1, exponent: 2, constant: -9 }, // xÂ² - 9
                initialHand: ['substitute', 'substitute', 'plus', 'substitute'],
                cardQueue: ['substitute', 'plus', 'substitute', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 0 }, // 0
                description: 'ä»£å…¥ã‚«ãƒ¼ãƒ‰ã‚’åˆæˆã—ã¦0ã«ã—ã‚ˆã†'
            },
            2: {
                name: 'åˆæˆã®ç·´ç¿’',
                difficulty: 1,
                enemyFunction: { coefficient: 0.5, exponent: 2, constant: -5 }, // (1/2)xÂ² - 5
                initialHand: ['multiply', 'plus', 'substitute', 'substitute'],
                cardQueue: ['substitute', 'derivative', 'substitute', 'substitute', 'plus'],
                maxTurns: 6,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 0 }, // 0
                description: 'Ã—2ã¨+1ã‚’ä½¿ã£ã¦ã€ä»£å…¥ã§0ã«ã—ã‚ˆã†'
            },
            3: {
                name: 'ä¿‚æ•°ã‚’æƒãˆã‚‹',
                difficulty: 2,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0 }, // x
                initialHand: ['multiply', 'multiply', 'multiply', 'plus'],
                cardQueue: ['plus', 'substitute', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 8, exponent: 1, constant: 0 }, // 8x
                description: 'Ã—2ã‚’3å›ä½¿ã£ã¦8xã«ã—ã‚ˆã†'
            },
            4: {
                name: 'å¾®åˆ†ã®å°å…¥',
                difficulty: 2,
                enemyFunction: { coefficient: 1, exponent: 3, constant: 0 }, // xÂ³
                initialHand: ['derivative', 'derivative', 'derivative', 'plus'],
                cardQueue: ['plus', 'plus', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 6 }, // 6
                description: 'å¾®åˆ†ã‚’ä½¿ã£ã¦é–¢æ•°ã‚’å¤‰æ›ã—ã‚ˆã†'
            },
            5: {
                name: 'ç©åˆ†ã®ç†è§£',
                difficulty: 2,
                enemyFunction: { coefficient: 6, exponent: 1, constant: 0 }, // 6x
                initialHand: ['integral', 'plus', 'derivative', 'multiply'],
                cardQueue: ['plus', 'plus', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 3, exponent: 2, constant: 0 }, // 3xÂ²
                description: 'ç©åˆ†ã‚’ä½¿ã£ã¦é–¢æ•°ã‚’å¤‰æ›ã—ã‚ˆã†'
            },
            6: {
                name: 'å¾®åˆ†ã®å¿œç”¨',
                difficulty: 3,
                enemyFunction: { coefficient: 1, exponent: 4, constant: 0 }, // xâ´
                initialHand: ['derivative', 'derivative', 'derivative', 'multiply'],
                cardQueue: ['plus', 'substitute', 'plus'],
                maxTurns: 5,
                clearCondition: 'target',
                targetFunction: { coefficient: 24, exponent: 1, constant: 0 }, // 24x
                description: 'å¾®åˆ†ã‚’3å›ä½¿ã£ã¦å¤‰æ›ã—ã‚ˆã†'
            },
            7: {
                name: 'ç©åˆ†ã§æ§‹ç¯‰',
                difficulty: 3,
                enemyFunction: { coefficient: 2, exponent: 1, constant: 0 }, // 2x
                initialHand: ['integral', 'multiply', 'multiply', 'derivative'],
                cardQueue: ['plus', 'substitute', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 4, exponent: 2, constant: 0 }, // 4xÂ²
                description: 'ç©åˆ†ã¨Ã—2ã‚’çµ„ã¿åˆã‚ã›ã‚ˆã†'
            },
            8: {
                name: 'æŒ‡æ•°é–¢æ•°ã¨log',
                difficulty: 4,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0, funcType: 'exp' }, // e^x
                initialHand: ['logify', 'substitute', 'plus', 'derivative'],
                cardQueue: ['plus', 'plus', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 1 }, // 1
                description: 'log_eã‚’æ´»ç”¨ã—ã¦å¤‰æ›ã—ã‚ˆã†'
            },
            9: {
                name: 'siné–¢æ•°ã®åˆ¶å¾¡',
                difficulty: 4,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0, funcType: 'sin' }, // sin(x)
                initialHand: ['substitute_pi', 'plus', 'derivative', 'substitute'],
                cardQueue: ['plus', 'plus', 'plus'],
                maxTurns: 3,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 0 }, // 0
                description: 'siné–¢æ•°ã‚’0ã«ã—ã‚ˆã†'
            },
            10: {
                name: 'ä¸‰è§’å¾®åˆ†ã®å‘¨æœŸæ€§',
                difficulty: 5,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0, funcType: 'sin' }, // sin(x)
                initialHand: ['derivative', 'derivative', 'multiply', 'substitute_pi'],
                cardQueue: ['plus', 'derivative', 'integral'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 0 }, // 0
                description: 'å¾®åˆ†ã‚’2å›ä½¿ã„ã€ä¿‚æ•°èª¿æ•´ã—ã¦Ï€ä»£å…¥ã§0ã«'
            },
            11: {
                name: '2sin(x) + 3 ã‚’ 0 ã«',
                difficulty: 7,
                enemyFunction: { coefficient: 2, exponent: 1, constant: 3, funcType: 'sin' }, // 2sin(x) + 3
                initialHand: ['derivative', 'derivative', 'limit_zero', 'plus'],
                cardQueue: ['plus', 'plus', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 0 }, // 0
                description: '2sin(x) + 3 ã‚’ 0 ã«å¤‰æ›'
            },
            12: {
                name: '-cos(x) ã‚’ -1 ã«',
                difficulty: 7,
                enemyFunction: { coefficient: -1, exponent: 1, constant: 0, funcType: 'cos' }, // -cos(x)
                initialHand: ['derivative', 'derivative', 'limit_zero', 'plus'],
                cardQueue: ['plus'],
                maxTurns: 3,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: -1 }, // -1
                description: '-cos(x) ã‚’ -1 ã«å¤‰æ›'
            },
            13: {
                name: 'e^x ã‚’ 1 ã«',
                difficulty: 8,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0, funcType: 'exp' }, // e^x
                initialHand: ['derivative', 'derivative', 'limit_zero', 'plus'],
                cardQueue: ['plus'],
                maxTurns: 3,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 1 }, // 1
                description: 'e^x ã‚’ 1 ã«å¤‰æ›'
            },
            14: {
                name: 'sin(x) ã‚’ 1 ã«',
                difficulty: 8,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0, funcType: 'sin' }, // sin(x)
                initialHand: ['integral', 'integral', 'derivative', 'derivative'],
                cardQueue: ['limit_zero', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 1 }, // 1
                description: 'sin(x) ã‚’ 1 ã«å¤‰æ›'
            },
            15: {
                name: 'cos(x) ã‚’ 0 ã«',
                difficulty: 9,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0, funcType: 'cos' }, // cos(x)
                initialHand: ['derivative', 'derivative', 'limit_zero', 'substitute_pi'],
                cardQueue: ['plus', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 0 }, // 0
                description: 'cos(x) ã‚’ 0 ã«å¤‰æ›'
            },
            16: {
                name: 'sin(x) + 3 ã‚’ 0 ã«',
                difficulty: 9,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 3, funcType: 'sin' }, // sin(x) + 3
                initialHand: ['derivative', 'derivative', 'limit_zero', 'plus'],
                cardQueue: ['plus', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 0 }, // 0
                description: 'sin(x) + 3 ã‚’ 0 ã«å¤‰æ›'
            },
            17: {
                name: 'e^x ã‚’ 1 ã« (å¯¾æ•°çµŒç”±)',
                difficulty: 10,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0, funcType: 'exp' }, // e^x
                initialHand: ['logify', 'derivative', 'derivative', 'limit_zero'],
                cardQueue: ['plus', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 1 }, // 1
                description: 'e^x ã‚’ 1 ã«å¤‰æ›ï¼ˆå¯¾æ•°ã‚’ä½¿ç”¨ï¼‰'
            },
            18: {
                name: 'cos(x) ã‚’ 1 ã«',
                difficulty: 10,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0, funcType: 'cos' }, // cos(x)
                initialHand: ['derivative', 'derivative', 'derivative', 'derivative'],
                cardQueue: ['limit_zero', 'plus'],
                maxTurns: 4,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 1 }, // 1
                description: 'cos(x) ã‚’ 1 ã«å¤‰æ›'
            },
            19: {
                name: 'sin(x) ã‚’ 0 ã« (é€£é–)',
                difficulty: 11,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0, funcType: 'sin' }, // sin(x)
                initialHand: ['integral', 'integral', 'derivative', 'derivative'],
                cardQueue: ['derivative', 'derivative', 'limit_zero', 'plus'],
                maxTurns: 5,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 0 }, // 0
                description: 'sin(x) ã‚’ 0 ã«å¤‰æ›ï¼ˆç©åˆ†â†’å¾®åˆ†ï¼‰'
            },
            20: {
                name: 'cos(x) ã‚’ 0 ã« (ç·åˆ)',
                difficulty: 12,
                enemyFunction: { coefficient: 1, exponent: 1, constant: 0, funcType: 'cos' }, // cos(x)
                initialHand: ['integral', 'integral', 'derivative', 'derivative'],
                cardQueue: ['derivative', 'derivative', 'limit_zero', 'substitute_pi', 'plus'],
                maxTurns: 6,
                clearCondition: 'target',
                targetFunction: { coefficient: 0, exponent: 0, constant: 0 }, // 0
                description: 'cos(x) ã‚’ 0 ã«å¤‰æ›ï¼ˆå…¨æŠ€è¡“ä½¿ç”¨ï¼‰'
            }
        };

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            currentStage: 1,
            enemyFunction: { coefficient: 1, exponent: 2, constant: -6 },
            hand: [],
            selectedCardIndex: null,
            mergeMode: false,
            selectedForMerge: [],
            remainingTurns: 5,
            maxTurns: 5,
            newCardIndices: [],
            cardQueue: [], // è£œå……ã‚«ãƒ¼ãƒ‰ã®ã‚­ãƒ¥ãƒ¼
            cardQueueIndex: 0, // ç¾åœ¨ã®è£œå……ä½ç½®
            explanationMode: false, // ã‚«ãƒ¼ãƒ‰èª¬æ˜ãƒ¢ãƒ¼ãƒ‰
            operationHistory: [] // æ“ä½œå±¥æ­´
        };

        // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—å®šç¾©
        const cardTypes = {
            plus: { name: '+1ã‚«ãƒ¼ãƒ‰', type: 'plus', description: 'f(x) + 1', color: 'plus' },
            substitute: { name: 'x=1ä»£å…¥', type: 'substitute', description: 'f(1) ã‚’è¨ˆç®—', color: 'substitute' },
            substitute_pi: { name: 'x=Ï€ä»£å…¥', type: 'substitute_pi', description: 'f(Ï€) ã‚’è¨ˆç®—', color: 'substitute' },
            inverse: { name: 'é€†æ•°ã‚«ãƒ¼ãƒ‰', type: 'inverse', description: '1/f(x)', color: 'inverse' },
            derivative: { name: 'å¾®åˆ†ã‚«ãƒ¼ãƒ‰', type: 'derivative', description: "f'(x)", color: 'derivative' },
            integral: { name: 'ç©åˆ†ã‚«ãƒ¼ãƒ‰', type: 'integral', description: 'âˆ«f(x)dx', color: 'integral' },
            multiply: { name: 'Ã—2ã‚«ãƒ¼ãƒ‰', type: 'multiply', description: '2Ã—f(x)', color: 'multiply' },
            sinify: { name: 'sinå¤‰æ›', type: 'sinify', description: 'sin(f(x))', color: 'sinify' },
            expify: { name: 'æŒ‡æ•°åŒ–', type: 'expify', description: 'e^(f(x))', color: 'expify' },
            logify: { name: 'å¯¾æ•°åŒ–', type: 'logify', description: 'log_e(f(x))', color: 'logify' },
            limit_zero: { name: 'æ¥µé™(xâ†’0)', type: 'limit_zero', description: 'lim[xâ†’0] f(x)', color: 'limit' }
        };

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–é–¢æ•°
        function init(stageNum = 1) {
            const stage = stageData[stageNum];
            
            // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸåŒ–
            gameState.currentStage = stageNum;
            gameState.enemyFunction = { ...stage.enemyFunction };
            gameState.maxTurns = stage.maxTurns;
            gameState.remainingTurns = stage.maxTurns;
            gameState.cardQueue = [...stage.cardQueue];
            gameState.cardQueueIndex = 0;
            gameState.operationHistory = []; // æ“ä½œå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
            
            // åˆæœŸæ‰‹æœ­ã‚’é…ã‚‹
            gameState.hand = stage.initialHand.map((type, i) => ({
                ...cardTypes[type],
                level: 1,
                id: Date.now() + i
            }));
            
            // ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('stage-info').textContent = `Stage ${stageNum}: ${stage.name}`;
            
            // ã‚¯ãƒªã‚¢æ¡ä»¶ã‚’è¡¨ç¤º
            let clearConditionText = '';
            if (stage.clearCondition === 'zero') {
                clearConditionText = 'ã‚¯ãƒªã‚¢æ¡ä»¶: ã“ã®é–¢æ•°ã‚’0ã«ã™ã‚‹';
            } else if (stage.clearCondition === 'constant') {
                clearConditionText = 'ã‚¯ãƒªã‚¢æ¡ä»¶: ã“ã®é–¢æ•°ã‚’å®šæ•°ã«ã™ã‚‹';
            } else if (stage.clearCondition === 'target' && stage.targetFunction) {
                const targetStr = formatFunction(stage.targetFunction, 'h');
                clearConditionText = `ã‚¯ãƒªã‚¢æ¡ä»¶: ${targetStr.replace('h(x) = ', '')} ã«å¤‰æ›ã™ã‚‹`;
            }
            document.getElementById('clear-condition-text').textContent = clearConditionText;
            
            renderHand();
            renderFunction();
            updateTurnCount();
            updateNextCardDisplay();
            addLog(`Stage ${stageNum}: ${stage.name} é–‹å§‹ï¼`);
        }

        // æ‰‹æœ­ã‚’æç”»
        function renderHand() {
            const handElement = document.getElementById('hand');
            handElement.innerHTML = '';

            gameState.hand.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = `card ${card.color}`;
                
                // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã«ã®ã¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
                if (gameState.newCardIndices.includes(index)) {
                    cardElement.classList.add('new-card');
                }
                
                if (gameState.selectedCardIndex === index && !gameState.mergeMode) {
                    cardElement.classList.add('selected');
                }

                if (gameState.mergeMode && gameState.selectedForMerge.includes(index)) {
                    cardElement.classList.add('selected');
                }

                // ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ«
                let levelClass = '';
                if (card.level === 2) {
                    levelClass = 'silver';
                } else if (card.level >= 3) {
                    levelClass = 'gold';
                }

                // ã‚«ãƒ¼ãƒ‰ä¸­å¤®ã®åŠ¹æœè¡¨ç¤º
                const centerEffect = getCardCenterEffect(card);
                const displayName = getCardDisplayName(card);

                cardElement.innerHTML = `
                    <div class="card-level ${levelClass}">Lv${card.level}</div>
                    <div class="card-name">${displayName}</div>
                    <div class="card-effect">${centerEffect}</div>
                    <div class="card-description">${getCardDescription(card)}</div>
                `;

                cardElement.onclick = () => selectCard(index);
                handElement.appendChild(cardElement);
            });

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã€newCardIndicesã‚’ã‚¯ãƒªã‚¢
            if (gameState.newCardIndices.length > 0) {
                setTimeout(() => {
                    gameState.newCardIndices = [];
                }, 400);
            }
        }

        // ã‚«ãƒ¼ãƒ‰ä¸­å¤®ã®åŠ¹æœè¡¨ç¤ºã‚’å–å¾—
        function getCardCenterEffect(card) {
            if (card.type === 'plus') {
                return `+${card.level}`;
            } else if (card.type === 'substitute') {
                return `f(${card.level})`;
            } else if (card.type === 'substitute_pi') {
                return `f(Ï€)`;
            } else if (card.type === 'inverse') {
                if (card.level % 2 === 0) {
                    return 'f(x)/1';
                } else {
                    return '1/f(x)';
                }
            } else if (card.type === 'derivative') {
                if (card.level === 1) {
                    return "d/dx";
                } else if (card.level === 2) {
                    return "Î£a<sub>n</sub>x<sup>n</sup>/n!";  // ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³å±•é–‹ã®å…¬å¼
                } else {
                    return `d${card.level}/dx${card.level}`;
                }
            } else if (card.type === 'integral') {
                if (card.level === 1) {
                    return "âˆ«dx";
                } else if (card.level === 2) {
                    return "âˆ«<sub>ç‰¹æ®Š</sub>";  // ç‰¹æ®Šç©åˆ†
                } else {
                    return `${'âˆ«'.repeat(card.level)}dx`;
                }
            } else if (card.type === 'multiply') {
                return `Ã—${Math.pow(2, card.level)}`;
            } else if (card.type === 'sinify') {
                return 'sin( )';
            } else if (card.type === 'expify') {
                return 'e^( )';
            } else if (card.type === 'logify') {
                return 'log<sub>e</sub>( )';
            } else if (card.type === 'limit_zero') {
                return 'lim<br><span style="font-size:0.7em;">xâ†’0</span>';
            }
            return '';
        }

        // ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºåã‚’å–å¾—ï¼ˆãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å¤‰åŒ–ï¼‰
        function getCardDisplayName(card) {
            if (card.type === 'derivative' && card.level === 2) {
                return 'ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³å±•é–‹';
            } else if (card.type === 'integral' && card.level === 2) {
                return 'ç‰¹æ®Šç©åˆ†';
            }
            return card.name;
        }

        // ã‚«ãƒ¼ãƒ‰ã®èª¬æ˜æ–‡ã‚’å–å¾—
        function getCardDescription(card) {
            if (card.type === 'plus') {
                return card.level === 1 ? 'f(x) â†’ f(x) + 1' : `f(x) â†’ f(x) + ${card.level}`;
            } else if (card.type === 'substitute') {
                return `f(x) â†’ f(${card.level})`;
            } else if (card.type === 'substitute_pi') {
                return `f(x) â†’ f(Ï€)`;
            } else if (card.type === 'inverse') {
                if (card.level === 1) return 'f(x) â†’ 1/f(x)';
                if (card.level % 2 === 0) return 'f(x) â†’ f(x) (ç„¡åŠ¹åŒ–)';
                return 'f(x) â†’ 1/f(x)';
            } else if (card.type === 'derivative') {
                if (card.level === 1) return "f(x) â†’ f'(x)";
                if (card.level === 2) return "ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³å±•é–‹";
                return `f(x) â†’ f${"'".repeat(card.level)}(x)`;
            } else if (card.type === 'integral') {
                if (card.level === 1) return 'f(x) â†’ âˆ«f(x)dx';
                if (card.level === 2) return 'ç‰¹æ®Šç©åˆ†';
                return `f(x) â†’ ${'âˆ«'.repeat(card.level)}f(x)${'dx'.repeat(card.level)}`;
            } else if (card.type === 'multiply') {
                const multiplier = Math.pow(2, card.level);
                return `f(x) â†’ ${multiplier}f(x)`;
            } else if (card.type === 'sinify') {
                return 'f(x) â†’ sin(f(x))';
            } else if (card.type === 'expify') {
                return 'f(x) â†’ e^(f(x))';
            } else if (card.type === 'logify') {
                return 'f(x) â†’ log_e(f(x))';
            } else if (card.type === 'limit_zero') {
                return 'lim[xâ†’0] f(x)';
            }
            return card.description;
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ
        function selectCard(index) {
            // èª¬æ˜ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯è©³ç´°ã‚’è¡¨ç¤º
            if (gameState.explanationMode) {
                const card = gameState.hand[index];
                showCardDetail(card);
                return;
            }
            
            if (gameState.mergeMode) {
                // åˆæˆãƒ¢ãƒ¼ãƒ‰
                if (gameState.selectedForMerge.includes(index)) {
                    gameState.selectedForMerge = gameState.selectedForMerge.filter(i => i !== index);
                } else if (gameState.selectedForMerge.length < 2) {
                    gameState.selectedForMerge.push(index);
                }

                // 2æšé¸æŠã•ã‚ŒãŸã‚‰åˆæˆå®Ÿè¡Œ
                if (gameState.selectedForMerge.length === 2) {
                    attemptMerge();
                }
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
                gameState.selectedCardIndex = index;
                document.getElementById('btn-use').disabled = false;
            }
            renderHand();
        }

        // ã‚«ãƒ¼ãƒ‰ä½¿ç”¨
        function useCard() {
            if (gameState.selectedCardIndex === null) return;

            const card = gameState.hand[gameState.selectedCardIndex];
            
            // æ“ä½œå‰ã®é–¢æ•°ã‚’è¨˜éŒ²
            const beforeFunc = formatFunction({...gameState.enemyFunction}, 'g');
            
            // ã‚«ãƒ¼ãƒ‰åŠ¹æœã‚’é©ç”¨
            applyCardEffect(card, gameState.enemyFunction);
            
            // æ“ä½œå¾Œã®é–¢æ•°ã‚’è¨˜éŒ²
            const afterFunc = formatFunction({...gameState.enemyFunction}, 'g');
            
            // è¡¨ç¤ºåã‚’å–å¾—
            const displayName = getCardDisplayName(card);
            
            // æ“ä½œå±¥æ­´ã«è¿½åŠ 
            gameState.operationHistory.push({
                cardName: displayName,
                before: beforeFunc,
                after: afterFunc,
                turn: gameState.maxTurns - gameState.remainingTurns + 1
            });
            
            addLog(`${displayName} ã‚’ä½¿ç”¨`);

            // ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã‹ã‚‰å‰Šé™¤
            gameState.hand.splice(gameState.selectedCardIndex, 1);
            gameState.selectedCardIndex = null;
            document.getElementById('btn-use').disabled = true;

            // ã‚¿ãƒ¼ãƒ³æ¸›å°‘
            gameState.remainingTurns--;
            updateTurnCount();

            // ã‚«ãƒ¼ãƒ‰ã‚’è£œå……ï¼ˆå¸¸ã«4æšã‚’ã‚­ãƒ¼ãƒ—ï¼‰
            if (gameState.hand.length < 4 && gameState.cardQueueIndex < gameState.cardQueue.length) {
                const nextCardType = gameState.cardQueue[gameState.cardQueueIndex];
                const newCard = { ...cardTypes[nextCardType], level: 1, id: Date.now() };
                gameState.hand.unshift(newCard);
                gameState.newCardIndices = [0];
                gameState.cardQueueIndex++;
                addLog(`${newCard.name} ã‚’è£œå……`);
            }

            renderHand();
            
            // ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ã®ã‚°ãƒ­ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            const battleArea = document.querySelector('.battle-area');
            battleArea.classList.add('active');
            setTimeout(() => {
                battleArea.classList.remove('active');
            }, 600);
            
            renderFunction();
            updateNextCardDisplay();
            
            // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
            if (!checkGameEnd()) {
                // ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
                if (gameState.remainingTurns <= 0) {
                    showModal('defeat', 'å¤±æ•—', 'ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Œã§ã™ã€‚ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã‚ˆã†ï¼');
                }
            }
        }

        // ç‰¹æ®Šé–¢æ•°ã«xã‚’ä»£å…¥ã—ã¦å®šæ•°ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function evaluateSpecialFunc(funcType, x) {
            switch(funcType) {
                case 'sin':     return Math.sin(x);
                case 'cos':     return Math.cos(x);
                case 'neg_sin': return -Math.sin(x);
                case 'neg_cos': return -Math.cos(x);
                case 'exp':     return Math.exp(x);
                case 'log':     return Math.log(x);
                default:        return null;
            }
        }

        // ã‚«ãƒ¼ãƒ‰åŠ¹æœã‚’é©ç”¨
        function applyCardEffect(card, func) {
            if (card.type === 'plus') {
                // å…¨ã¦ã®é–¢æ•°ã«å®šæ•°ã‚’è¶³ã›ã‚‹
                func.constant += card.level;
            } else if (card.type === 'substitute' || card.type === 'substitute_pi') {
                // ä»£å…¥: x = n ã¾ãŸã¯ x = Ï€
                const x = (card.type === 'substitute_pi') ? Math.PI : card.level;
                
                if (func.funcType) {
                    // ç‰¹æ®Šé–¢æ•°ã®ä»£å…¥: coef*f(x) + const
                    const coef = func.coefficient;
                    const cnst = func.constant;
                    const result = coef * evaluateSpecialFunc(func.funcType, x) + cnst;
                    delete func.funcType;
                    func.coefficient = result;
                    func.exponent = 0;
                    func.constant = 0;
                } else {
                    // é€šå¸¸ã®å¤šé …å¼ã®ä»£å…¥
                    const result = func.coefficient * Math.pow(x, func.exponent) + func.constant;
                    func.coefficient = result;
                    func.exponent = 0;
                    func.constant = 0;
                }
            } else if (card.type === 'inverse') {
                if (card.level % 2 === 1) {
                    if (func.exponent === 0) {
                        const value = func.coefficient + func.constant;
                        if (value !== 0) {
                            func.coefficient = 1 / value;
                            func.constant = 0;
                        }
                    } else {
                        if (func.coefficient !== 0) {
                            func.coefficient = 1 / func.coefficient;
                            func.exponent = -func.exponent;
                            if (func.constant !== 0) {
                                func.constant = -func.constant / Math.abs(func.coefficient);
                            }
                        }
                    }
                }
            } else if (card.type === 'derivative') {
                if (card.level >= 2) {
                    // ===== å¾®åˆ†Lv2: ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³å±•é–‹ =====
                    if (func.funcType === 'sin') {
                        // coef*sin(x) + const â†’ coef*x + const
                        const coef = func.coefficient;
                        const cnst = func.constant;
                        delete func.funcType;
                        func.coefficient = coef;
                        func.exponent = 1;
                        func.constant = cnst;
                    } else if (func.funcType === 'cos') {
                        // coef*cos(x) + const â†’ coef*(1 - xÂ²/2) + const = coef - coef*xÂ²/2 + const
                        const coef = func.coefficient;
                        const cnst = func.constant;
                        delete func.funcType;
                        func.coefficient = -coef * 0.5;
                        func.exponent = 2;
                        func.constant = coef + cnst;
                    } else if (func.funcType === 'neg_sin') {
                        // coef*(-sin(x)) + const â†’ coef*(-x) + const = -coef*x + const
                        const coef = func.coefficient;
                        const cnst = func.constant;
                        delete func.funcType;
                        func.coefficient = -coef;
                        func.exponent = 1;
                        func.constant = cnst;
                    } else if (func.funcType === 'neg_cos') {
                        // coef*(-cos(x)) + const â†’ coef*(-(1 - xÂ²/2)) + const = -coef + coef*xÂ²/2 + const
                        const coef = func.coefficient;
                        const cnst = func.constant;
                        delete func.funcType;
                        func.coefficient = coef * 0.5;
                        func.exponent = 2;
                        func.constant = -coef + cnst;
                    } else if (func.funcType === 'exp') {
                        // coef*e^x + const â†’ coef*(1 + x) + const = coef*x + (coef + const)
                        const coef = func.coefficient;
                        const cnst = func.constant;
                        delete func.funcType;
                        func.coefficient = coef;
                        func.exponent = 1;
                        func.constant = coef + cnst;
                    } else {
                        // å¤šé …å¼ã¯ãã®ã¾ã¾ï¼ˆå¤‰åŒ–ãªã—ï¼‰
                    }
                } else {
                    // ===== å¾®åˆ†Lv1: é€šå¸¸å¾®åˆ† =====
                    // ä¸‰è§’é–¢æ•°ã®å¾®åˆ†ã‚µã‚¤ã‚¯ãƒ«: sinâ†’cosâ†’-sinâ†’-cosâ†’sin
                    if (func.funcType === 'sin') {
                        func.funcType = 'cos';
                    } else if (func.funcType === 'cos') {
                        func.funcType = 'neg_sin';
                    } else if (func.funcType === 'neg_sin') {
                        func.funcType = 'neg_cos';
                    } else if (func.funcType === 'neg_cos') {
                        func.funcType = 'sin';
                    } else if (func.funcType === 'exp') {
                        // e^x â†’ e^x (å¤‰åŒ–ãªã—)
                    } else {
                        // é€šå¸¸ã®å¾®åˆ†: ax^n + c â†’ n*a*x^(n-1)
                        if (func.exponent > 0) {
                            func.coefficient = func.coefficient * func.exponent;
                            func.exponent = func.exponent - 1;
                            func.constant = 0;
                        } else {
                            func.coefficient = 0;
                            func.exponent = 0;
                            func.constant = 0;
                        }
                    }
                }
            } else if (card.type === 'integral') {
                if (card.level >= 2) {
                    // ===== ç©åˆ†Lv2: ç‰¹æ®Šç©åˆ†ï¼ˆä¸‰è§’é–¢æ•°ã®åå°é–¢æ•°ï¼‰ =====
                    // ç©åˆ†ã‚µã‚¤ã‚¯ãƒ«: sinâ†’-cosâ†’-sinâ†’cosâ†’sin
                    if (func.funcType === 'sin') {
                        func.funcType = 'neg_cos';
                    } else if (func.funcType === 'cos') {
                        func.funcType = 'sin';
                    } else if (func.funcType === 'neg_sin') {
                        func.funcType = 'cos';
                    } else if (func.funcType === 'neg_cos') {
                        func.funcType = 'neg_sin';
                    } else if (func.funcType === 'exp') {
                        // e^x ã®ç©åˆ†ã‚‚ e^x
                    } else {
                        // å¤šé …å¼ã¯é€šå¸¸ã®ç©åˆ†ã¨åŒã˜
                        func.coefficient = func.coefficient / (func.exponent + 1);
                        func.exponent = func.exponent + 1;
                    }
                } else {
                    // ===== ç©åˆ†Lv1: é€šå¸¸ç©åˆ† =====
                    // ç‰¹æ®Šé–¢æ•°ã«ã¯åŠ¹ã‹ãªã„ï¼ˆLv2ãŒå¿…è¦ï¼‰
                    if (!func.funcType) {
                        func.coefficient = func.coefficient / (func.exponent + 1);
                        func.exponent = func.exponent + 1;
                    }
                }
            } else if (card.type === 'multiply') {
                const multiplier = Math.pow(2, card.level);
                // å…¨ã¦ã®é–¢æ•°ã«ä¿‚æ•°ã‚’ã‹ã‘ã‚‰ã‚Œã‚‹
                func.coefficient = func.coefficient * multiplier;
                func.constant = func.constant * multiplier;
            } else if (card.type === 'sinify') {
                func.funcType = 'sin';
                func.coefficient = 1; func.exponent = 1; func.constant = 0;
            } else if (card.type === 'expify') {
                func.funcType = 'exp';
                func.coefficient = 1; func.exponent = 1; func.constant = 0;
            } else if (card.type === 'logify') {
                if (func.funcType === 'exp') {
                    delete func.funcType;
                    func.coefficient = 1; func.exponent = 1; func.constant = 0;
                } else {
                    func.funcType = 'log';
                    func.coefficient = 1; func.exponent = 1; func.constant = 0;
                }
            } else if (card.type === 'limit_zero') {
                // æ¥µé™ xâ†’0 ã®è¨ˆç®—
                // sin(x) â†’ 0, cos(x) â†’ 1, e^x â†’ 1, x^n â†’ 0, const â†’ const
                if (func.funcType) {
                    // ç‰¹æ®Šé–¢æ•°ã®æ¥µé™
                    const cnst = func.constant;  // å®šæ•°é …ã¯ä¿æŒ
                    if (func.funcType === 'sin' || func.funcType === 'neg_sin') {
                        // sin(x) â†’ 0, -sin(x) â†’ 0
                        delete func.funcType;
                        func.coefficient = 0;
                        func.exponent = 0;
                        func.constant = cnst;
                    } else if (func.funcType === 'cos') {
                        // cos(x) â†’ 1
                        const coef = func.coefficient;
                        delete func.funcType;
                        func.coefficient = coef;  // ä¿‚æ•°Ã—1 = ä¿‚æ•°
                        func.exponent = 0;
                        func.constant = cnst;
                    } else if (func.funcType === 'neg_cos') {
                        // -cos(x) â†’ -1
                        const coef = func.coefficient;
                        delete func.funcType;
                        func.coefficient = -coef;  // ä¿‚æ•°Ã—(-1) = -ä¿‚æ•°
                        func.exponent = 0;
                        func.constant = cnst;
                    } else if (func.funcType === 'exp') {
                        // e^x â†’ 1
                        const coef = func.coefficient;
                        delete func.funcType;
                        func.coefficient = coef;  // ä¿‚æ•°Ã—1 = ä¿‚æ•°
                        func.exponent = 0;
                        func.constant = cnst;
                    } else {
                        delete func.funcType;
                        func.coefficient = 0;
                        func.exponent = 0;
                        func.constant = cnst;
                    }
                } else {
                    // å¤šé …å¼ã®æ¥µé™: xâ†’0 ã§å®šæ•°é …ã®ã¿æ®‹ã‚‹
                    func.coefficient = func.constant;
                    func.exponent = 0;
                    func.constant = 0;
                }
            }
        }

        // é–¢æ•°ã‚’æç”»
        function renderFunction() {
            const element = document.getElementById('enemy-function');
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            element.classList.add('changing');
            
            // æ–°ã—ã„é–¢æ•°ã‚’è¡¨ç¤º
            element.innerHTML = formatFunction(gameState.enemyFunction, 'g');
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            setTimeout(() => {
                element.classList.remove('changing');
            }, 600);
        }

        // é–¢æ•°ã‚’æ•´å½¢
        function formatFunction(func, fname) {
            // ç‰¹æ®Šé–¢æ•°ã‚¿ã‚¤ãƒ—ã®å‡¦ç†ï¼ˆä¿‚æ•°ã¨å®šæ•°é …ã‚‚è€ƒæ…®ï¼‰
            if (func.funcType === 'sin' || func.funcType === 'cos' || 
                func.funcType === 'neg_sin' || func.funcType === 'neg_cos' || 
                func.funcType === 'exp' || func.funcType === 'log') {
                
                let result = `${fname}(x) = `;
                
                // ä¿‚æ•°éƒ¨åˆ†
                let coeffPart = '';
                if (func.coefficient === 1) {
                    coeffPart = '';
                } else if (func.coefficient === -1) {
                    coeffPart = 'âˆ’';
                } else if (func.coefficient === 0) {
                    // ä¿‚æ•°0ã®å ´åˆã¯å®šæ•°é …ã®ã¿
                    const constValue = func.constant;
                    if (Number.isInteger(constValue)) {
                        return result + constValue;
                    } else {
                        return result + formatFraction(constValue);
                    }
                } else {
                    if (Number.isInteger(func.coefficient)) {
                        coeffPart = func.coefficient.toString();
                    } else {
                        if (func.coefficient < 0) {
                            coeffPart = 'âˆ’' + formatFraction(-func.coefficient);
                        } else {
                            coeffPart = formatFraction(func.coefficient);
                        }
                    }
                }
                
                // é–¢æ•°æœ¬ä½“
                let funcPart = '';
                if (func.funcType === 'sin') {
                    funcPart = 'sin(x)';
                } else if (func.funcType === 'cos') {
                    funcPart = 'cos(x)';
                } else if (func.funcType === 'neg_sin') {
                    funcPart = 'âˆ’sin(x)';
                } else if (func.funcType === 'neg_cos') {
                    funcPart = 'âˆ’cos(x)';
                } else if (func.funcType === 'exp') {
                    funcPart = 'e<sup>x</sup>';
                } else if (func.funcType === 'log') {
                    funcPart = 'log<sub>e</sub>(x)';
                }
                
                result += coeffPart + funcPart;
                
                // å®šæ•°é …
                if (func.constant !== 0) {
                    if (func.constant > 0) {
                        result += ' + ' + (Number.isInteger(func.constant) ? func.constant : formatFraction(func.constant));
                    } else {
                        result += ' âˆ’ ' + (Number.isInteger(-func.constant) ? -func.constant : formatFraction(-func.constant));
                    }
                }
                
                return result;
            }
            
            let result = `${fname}(x) = `;
            
            // å®šæ•°ã®ã¿ã®å ´åˆ
            if (func.exponent === 0) {
                const value = func.coefficient + func.constant;
                if (Math.abs(value) < 0.0001) {
                    result += '0';
                } else if (Number.isInteger(value)) {
                    result += value;
                } else {
                    result += formatFraction(value);
                }
                return result;
            }

            // ä¿‚æ•°
            if (func.coefficient === 1) {
                // ä¿‚æ•°1ã¯çœç•¥ï¼ˆä½•ã‚‚æ›¸ã‹ãªã„ï¼‰
            } else if (func.coefficient === -1) {
                // ä¿‚æ•°-1ã¯ã€Œâˆ’ã€ã ã‘
                result += 'âˆ’';
            } else {
                if (Number.isInteger(func.coefficient)) {
                    result += func.coefficient;
                } else {
                    // è² ã®åˆ†æ•°ã®å ´åˆã¯ âˆ’åˆ†æ•° ã«ã™ã‚‹
                    if (func.coefficient < 0) {
                        result += 'âˆ’' + formatFraction(-func.coefficient);
                    } else {
                        result += formatFraction(func.coefficient);
                    }
                }
            }

            // x^n
            if (func.exponent === 1) {
                result += 'x';
            } else if (func.exponent !== 0) {
                result += `x<sup>${func.exponent}</sup>`;
            }

            // å®šæ•°é …
            if (func.constant !== 0) {
                if (func.constant > 0) {
                    result += ' + ' + (Number.isInteger(func.constant) ? func.constant : formatFraction(func.constant));
                } else {
                    result += ' - ' + (Number.isInteger(-func.constant) ? -func.constant : formatFraction(-func.constant));
                }
            }

            return result;
        }

        // åˆ†æ•°è¡¨è¨˜
        function formatFraction(num) {
            if (Number.isInteger(num)) return num.toString();
            
            const precision = 1000000;
            let numerator = Math.round(num * precision);
            let denominator = precision;
            
            const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
            const divisor = gcd(Math.abs(numerator), denominator);
            numerator /= divisor;
            denominator /= divisor;
            
            if (denominator === 1) return numerator.toString();
            return `${numerator}/${denominator}`;
        }

        // åˆæˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleMergeMode() {
            gameState.mergeMode = !gameState.mergeMode;
            gameState.selectedForMerge = [];
            
            if (gameState.mergeMode) {
                document.getElementById('merge-indicator').style.display = 'block';
                document.getElementById('btn-use').disabled = true;
                gameState.selectedCardIndex = null;
            } else {
                document.getElementById('merge-indicator').style.display = 'none';
            }
            
            renderHand();
        }

        // ã‚«ãƒ¼ãƒ‰åˆæˆã‚’è©¦ã¿ã‚‹
        function attemptMerge() {
            const [index1, index2] = gameState.selectedForMerge;
            const card1 = gameState.hand[index1];
            const card2 = gameState.hand[index2];

            if (card1.type === card2.type && card1.level === card2.level) {
                // åˆæˆæˆåŠŸ
                const newCard = {
                    ...card1,
                    level: card1.level + 1,
                    id: Date.now()
                };

                // ã‚ˆã‚Šå·¦å´ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®
                const keepIndex = Math.min(index1, index2);
                const removeIndex = Math.max(index1, index2);
                
                // å‰Šé™¤ã—ã¦ã‹ã‚‰æŒ¿å…¥
                gameState.hand.splice(removeIndex, 1);
                gameState.hand.splice(keepIndex, 1, newCard);

                addLog(`${card1.name} ã‚’åˆæˆã—ã¦Lv${newCard.level}ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰`);
                
                gameState.mergeMode = false;
                gameState.selectedForMerge = [];
                document.getElementById('merge-indicator').style.display = 'none';

                // ã‚¿ãƒ¼ãƒ³æ¸›å°‘
                gameState.remainingTurns--;
                updateTurnCount();

                // ã‚«ãƒ¼ãƒ‰ã‚’è£œå……ï¼ˆå¸¸ã«4æšã‚’ã‚­ãƒ¼ãƒ—ï¼‰
                while (gameState.hand.length < 4 && gameState.cardQueueIndex < gameState.cardQueue.length) {
                    const nextCardType = gameState.cardQueue[gameState.cardQueueIndex];
                    const plusCard = { ...cardTypes[nextCardType], level: 1, id: Date.now() + gameState.hand.length };
                    gameState.hand.unshift(plusCard);
                    gameState.cardQueueIndex++;
                }
                
                // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸè£œå……ã‚«ãƒ¼ãƒ‰ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
                if (gameState.hand.length === 4) {
                    gameState.newCardIndices = [0];
                } else {
                    gameState.newCardIndices = [];
                }
                
                renderHand();
                updateNextCardDisplay();

                // ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
                if (gameState.remainingTurns <= 0) {
                    showModal('defeat', 'å¤±æ•—', 'ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Œã§ã™ã€‚ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã‚ˆã†ï¼');
                }
            } else {
                addLog('åˆæˆå¤±æ•—: åŒã˜ã‚¿ã‚¤ãƒ—ãƒ»åŒã˜ãƒ¬ãƒ™ãƒ«ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
                gameState.selectedForMerge = [];
                renderHand();
            }
        }

        // ã‚¿ãƒ¼ãƒ³ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
        function updateTurnCount() {
            document.getElementById('turn-count').textContent = gameState.remainingTurns;
        }

        // æ¬¡ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
        function updateNextCardDisplay() {
            const nextCardElement = document.getElementById('next-card-display');
            if (gameState.cardQueueIndex < gameState.cardQueue.length) {
                const nextCardType = gameState.cardQueue[gameState.cardQueueIndex];
                const nextCard = cardTypes[nextCardType];
                nextCardElement.textContent = nextCard.name;
                nextCardElement.style.color = 'var(--accent-main)';
                nextCardElement.style.fontWeight = '600';
            } else {
                nextCardElement.textContent = 'ãªã—';
                nextCardElement.style.color = 'var(--text-secondary)';
                nextCardElement.style.fontWeight = '400';
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é–¢æ•°
        function saveBestClear(stage, turnsUsed) {
            const key = `stage${stage}_best`;
            const current = localStorage.getItem(key);
            
            if (!current || turnsUsed < parseInt(current)) {
                localStorage.setItem(key, turnsUsed.toString());
                return true; // æ–°è¨˜éŒ²
            }
            return false;
        }

        function getBestClear(stage) {
            const key = `stage${stage}_best`;
            const best = localStorage.getItem(key);
            return best ? parseInt(best) : null;
        }

        function updateStageRecordDisplay() {
            for (let i = 1; i <= 10; i++) {
                const best = getBestClear(i);
                const recordElement = document.getElementById(`stage${i}-record`);
                if (recordElement) {
                    if (best) {
                        recordElement.textContent = `æœ€é€Ÿã‚¯ãƒªã‚¢: ${best}ã‚¿ãƒ¼ãƒ³æ¶ˆè²»`;
                    } else {
                        recordElement.textContent = 'æœ€é€Ÿã‚¯ãƒªã‚¢: æœªæŒ‘æˆ¦';
                    }
                }
            }
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
        function checkGameEnd() {
            const func = gameState.enemyFunction;
            const stage = stageData[gameState.currentStage];
            const clearCondition = stage.clearCondition;
            
            // targetæ¡ä»¶: æŒ‡å®šã®é–¢æ•°ã«ä¸€è‡´
            if (clearCondition === 'target' && stage.targetFunction) {
                const target = stage.targetFunction;
                let matched = false;

                if (func.exponent === 0 && target.exponent === 0) {
                    // ä¸¡æ–¹ãŒå®šæ•°ã®å ´åˆ: coefficient+constant ã®åˆè¨ˆã§æ¯”è¼ƒ
                    const funcVal = func.coefficient + func.constant;
                    const targetVal = target.coefficient + target.constant;
                    matched = Math.abs(funcVal - targetVal) < 0.0001;
                } else {
                    // å¤šé …å¼ã®å ´åˆ: å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å€‹åˆ¥ã«æ¯”è¼ƒ
                    matched = Math.abs(func.coefficient - target.coefficient) < 0.0001 &&
                              func.exponent === target.exponent &&
                              Math.abs(func.constant - target.constant) < 0.0001;
                }

                if (matched) {
                    const turnsUsed = gameState.maxTurns - gameState.remainingTurns;
                    const isNewRecord = saveBestClear(gameState.currentStage, turnsUsed);
                    
                    let message = `${turnsUsed}ã‚¿ãƒ¼ãƒ³ã§ã‚¯ãƒªã‚¢ï¼\nç›®æ¨™ã®é–¢æ•°ã«å¤‰æ›ã—ã¾ã—ãŸï¼`;
                    if (isNewRecord) {
                        message += '\nğŸ‰ æ–°è¨˜éŒ²é”æˆï¼';
                    }
                    
                    showModal('victory', 'ã‚¯ãƒªã‚¢ï¼', message);
                    return true;
                }
            }
            
            // å®šæ•°ã«ãªã£ãŸå ´åˆ
            if (func.exponent === 0) {
                const value = func.coefficient + func.constant;
                
                if (clearCondition === 'zero') {
                    // 0ã«ã™ã‚‹æ¡ä»¶
                    if (Math.abs(value) < 0.0001 || value === 0) {
                        const turnsUsed = gameState.maxTurns - gameState.remainingTurns;
                        const isNewRecord = saveBestClear(gameState.currentStage, turnsUsed);
                        
                        let message = `${turnsUsed}ã‚¿ãƒ¼ãƒ³ã§ã‚¯ãƒªã‚¢ï¼`;
                        if (isNewRecord) {
                            message += '\nğŸ‰ æ–°è¨˜éŒ²é”æˆï¼';
                        }
                        
                        showModal('victory', 'ã‚¯ãƒªã‚¢ï¼', message);
                        return true;
                    }
                } else if (clearCondition === 'constant') {
                    // å®šæ•°ã«ã™ã‚‹æ¡ä»¶
                    const turnsUsed = gameState.maxTurns - gameState.remainingTurns;
                    const isNewRecord = saveBestClear(gameState.currentStage, turnsUsed);
                    
                    let message = `${turnsUsed}ã‚¿ãƒ¼ãƒ³ã§ã‚¯ãƒªã‚¢ï¼\né–¢æ•°ã‚’å®šæ•° ${value} ã«ã—ã¾ã—ãŸï¼`;
                    if (isNewRecord) {
                        message += '\nğŸ‰ æ–°è¨˜éŒ²é”æˆï¼';
                    }
                    
                    showModal('victory', 'ã‚¯ãƒªã‚¢ï¼', message);
                    return true;
                }
            }
            
            // æœªå®šç¾©ãƒ»ç™ºæ•£ãƒã‚§ãƒƒã‚¯
            const testValue = evaluateFunction(func);
            if (isNaN(testValue) || !isFinite(testValue)) {
                showModal('defeat', 'å¤±æ•—', 'é–¢æ•°ãŒæœªå®šç¾©ã«ãªã‚Šã¾ã—ãŸ...');
                return true;
            }

            return false;
        }

        // é–¢æ•°ã‚’è©•ä¾¡ï¼ˆä¸»ã«ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
        function evaluateFunction(func) {
            if (func.exponent === 0) {
                return func.coefficient + func.constant;
            }
            // x=1ã§ã®è©•ä¾¡ï¼ˆå‚è€ƒå€¤ã¨ã—ã¦ï¼‰
            return func.coefficient * Math.pow(1, func.exponent) + func.constant;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showModal(type, title, message) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            
            modalContent.className = `modal-content ${type}`;
            document.getElementById('modal-title').textContent = title;
            
            const messageElement = document.getElementById('modal-message');
            
            // å‹åˆ©æ™‚ã¯æ“ä½œå±¥æ­´ã‚’è¿½åŠ 
            if (type === 'victory' && gameState.operationHistory.length > 0) {
                let historyHTML = '<div style="margin-bottom: 20px; font-size: 1.05rem;">' + message + '</div>';
                historyHTML += '<div style="text-align: left; margin-top: 20px; padding: 18px; background: var(--bg-primary); border-radius: 8px; max-height: 320px; overflow-y: auto;">';
                historyHTML += '<h3 style="margin-bottom: 15px; color: var(--accent-main); font-size: 1.1rem; text-align: center;">ğŸ“ ã‚ãªãŸã®æ“ä½œ</h3>';
                
                gameState.operationHistory.forEach((op, index) => {
                    historyHTML += `
                        <div style="margin-bottom: 12px; padding: 12px; background: var(--bg-paper); border-radius: 6px; border-left: 3px solid var(--accent-main);">
                            <div style="font-weight: 600; color: var(--accent-main); margin-bottom: 6px; font-size: 0.95rem;">
                                ${op.turn}æ‰‹ç›®: ${op.cardName}
                            </div>
                            <div style="font-size: 0.88rem; line-height: 1.7; color: var(--text-primary);">
                                ${op.before}<br>
                                <span style="color: var(--accent-main); margin: 4px 0; display: inline-block;">â†“</span><br>
                                ${op.after}
                            </div>
                        </div>
                    `;
                });
                
                historyHTML += '</div>';
                messageElement.innerHTML = historyHTML;
            } else {
                messageElement.textContent = message;
            }
            
            modal.classList.add('active');
        }

        // ãƒ­ã‚°è¿½åŠ 
        function addLog(message) {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            log.insertBefore(entry, log.firstChild);

            while (log.children.length > 10) {
                log.removeChild(log.lastChild);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¸é–‹å§‹
        function startStage(stageNumber) {
            console.log('Starting stage:', stageNumber);
            try {
                document.getElementById('stage-select').style.display = 'none';
                document.getElementById('game-screen').classList.add('active');
                
                init(stageNumber);
            } catch (error) {
                console.error('Error starting stage:', error);
                alert('ã‚¹ãƒ†ãƒ¼ã‚¸é–‹å§‹ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªãƒˆãƒ©ã‚¤
        function retryStage() {
            document.getElementById('modal').classList.remove('active');
            const currentStageNum = gameState.currentStage;
            init(currentStageNum);
        }

        // ã‚«ãƒ¼ãƒ‰èª¬æ˜ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
        function openHelpModal() {
            gameState.explanationMode = true;
            document.getElementById('explanation-mode-banner').style.display = 'block';
            // åˆæˆãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
            gameState.mergeMode = false;
            gameState.selectedForMerge = [];
            document.getElementById('merge-indicator').style.display = 'none';
            renderHand();
        }

        // ã‚«ãƒ¼ãƒ‰èª¬æ˜ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
        function exitExplanationMode() {
            gameState.explanationMode = false;
            document.getElementById('explanation-mode-banner').style.display = 'none';
            renderHand();
        }

        // ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function showCardDetail(card) {
            const modal = document.getElementById('card-detail-modal');
            const title = document.getElementById('card-detail-title');
            const content = document.getElementById('card-detail-content');
            
            title.textContent = card.name + ' (ãƒ¬ãƒ™ãƒ« ' + card.level + ')';
            content.innerHTML = getCardDetailHTML(card);
            
            modal.classList.add('active');
        }

        // ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCardDetailModal() {
            document.getElementById('card-detail-modal').classList.remove('active');
        }

        // ã‚«ãƒ¼ãƒ‰è©³ç´°ã®HTMLç”Ÿæˆ
        function getCardDetailHTML(card) {
            let html = '';
            
            if (card.type === 'plus') {
                html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ“ åŸºæœ¬èª¬æ˜</h3>
                        <p>é–¢æ•°ã«å®šæ•°ã‚’è¶³ã™ã‚«ãƒ¼ãƒ‰ã§ã™ã€‚é–¢æ•°å…¨ä½“ã®å€¤ã‚’ä¸Šä¸‹ã«ãšã‚‰ã—ã¾ã™ã€‚</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ¯ åŠ¹æœ</h3>
                        <p><strong>f(x) â†’ f(x) + ${card.level}</strong></p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨ä¾‹</h3>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px;">
                            <p><strong>ä¾‹1:</strong> f(x) = xÂ² ã«ä½¿ç”¨</p>
                            <p>â†’ xÂ² + ${card.level}</p>
                            <p style="margin-top: 10px;"><strong>ä¾‹2:</strong> f(x) = 2x - 3 ã«ä½¿ç”¨</p>
                            <p>â†’ 2x - 3 + ${card.level} = 2x + ${card.level - 3}</p>
                        </div>
                    </div>
                    <div>
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ”„ åˆæˆ</h3>
                        <p>åŒã˜ãƒ¬ãƒ™ãƒ«ã®+1ã‚«ãƒ¼ãƒ‰2æšã‚’åˆæˆã™ã‚‹ã¨ã€ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã‚Šã¾ã™ã€‚</p>
                        <p>ãƒ¬ãƒ™ãƒ«${card.level} Ã— 2 â†’ ãƒ¬ãƒ™ãƒ«${card.level + 1} (+${card.level + 1}ã‚«ãƒ¼ãƒ‰)</p>
                    </div>
                `;
            } else if (card.type === 'substitute' || card.type === 'substitute_pi') {
                const value = card.type === 'substitute_pi' ? 'Ï€ â‰ˆ 3.14...' : card.level;
                const displayValue = card.type === 'substitute_pi' ? 'Ï€' : card.level;
                html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ“ åŸºæœ¬èª¬æ˜</h3>
                        <p>é–¢æ•°ã®xã«å…·ä½“çš„ãªæ•°å€¤ã‚’ä»£å…¥ã—ã¦ã€å®šæ•°ï¼ˆæ•°å€¤ï¼‰ã«å¤‰æ›ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã§ã™ã€‚</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ¯ åŠ¹æœ</h3>
                        <p><strong>f(x) â†’ f(${displayValue})</strong></p>
                        <p>xã®ä»£ã‚ã‚Šã«${value}ã‚’å…¥ã‚Œã¦è¨ˆç®—ã—ã¾ã™ã€‚</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨ä¾‹</h3>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px;">
                            <p><strong>ä¾‹1:</strong> f(x) = xÂ² ã«ä½¿ç”¨</p>
                            <p>â†’ (${displayValue})Â² ${card.type === 'substitute' ? `= ${card.level * card.level}` : 'â‰ˆ 9.87'}</p>
                            <p style="margin-top: 10px;"><strong>ä¾‹2:</strong> f(x) = 2x - 4 ã«ä½¿ç”¨</p>
                            <p>â†’ 2(${displayValue}) - 4 ${card.type === 'substitute' ? `= ${2 * card.level - 4}` : 'â‰ˆ 2.28'}</p>
                        </div>
                    </div>
                    ${card.type === 'substitute' ? `
                    <div>
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ”„ åˆæˆ</h3>
                        <p>åŒã˜ãƒ¬ãƒ™ãƒ«ã®ä»£å…¥ã‚«ãƒ¼ãƒ‰2æšã‚’åˆæˆã™ã‚‹ã¨ã€ä»£å…¥ã™ã‚‹å€¤ãŒå¢—ãˆã¾ã™ã€‚</p>
                        <p>ãƒ¬ãƒ™ãƒ«${card.level} Ã— 2 â†’ ãƒ¬ãƒ™ãƒ«${card.level + 1} (x=${card.level + 1}ä»£å…¥)</p>
                    </div>
                    ` : ''}
                `;
            } else if (card.type === 'derivative') {
                const isLv2 = card.level >= 2;
                html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ“ åŸºæœ¬èª¬æ˜</h3>
                        <p>å¾®åˆ†ã¯ã€Œå¤‰åŒ–ç‡ã€ã‚’æ±‚ã‚ã‚‹æ“ä½œã§ã™ã€‚é–¢æ•°ã®æ¬¡æ•°ã‚’1ã¤ä¸‹ã’ã¾ã™ã€‚</p>
                        ${isLv2 ? `<p style="margin-top: 12px; padding: 12px; background: rgba(106,90,205,0.12); border-left: 4px solid #6a5acd; border-radius: 4px;">
                            <strong style="color: #6a5acd;">â­ ãƒ¬ãƒ™ãƒ«2ã«ãªã‚‹ã¨ã€Œãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³å±•é–‹ã€ã«ãªã‚Šã¾ã™ï¼</strong><br>
                            ç‰¹æ®Šé–¢æ•°ã‚’å¤šé …å¼ã«å¤‰æ›ã™ã‚‹å¼·åŠ›ãªæ“ä½œã§ã™ã€‚
                        </p>` : ''}
                    </div>
                    ${isLv2 ? `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #6a5acd; margin-bottom: 10px;">ğŸŒŸ ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³å±•é–‹ã¨ã¯ï¼Ÿ</h3>
                        <p style="margin-bottom: 10px;">ä»»æ„ã®é–¢æ•°ã‚’ã€Œx=0ã®è¿‘ãã§ã®å¤šé …å¼ã€ã«è¿‘ä¼¼ã™ã‚‹æŠ€æ³•ã§ã™ã€‚</p>
                        <p style="margin-bottom: 12px;">ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ï¼šã¾ã‚‹ã£ã¨è¤‡é›‘ãªé–¢æ•°ã‚’ã€ã‚·ãƒ³ãƒ—ãƒ«ãªxã®å¼ã«ã€Œè§£èª­ã€ã™ã‚‹ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚</p>
                        <div style="background: rgba(106,90,205,0.08); padding: 15px; border-radius: 6px; margin-bottom: 12px;">
                            <p style="font-weight: 600; margin-bottom: 8px; color: #6a5acd;">ğŸ“ ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³å±•é–‹ã®å…¬å¼:</p>
                            <p style="text-align: center; font-size: 1.05rem; padding: 10px; background: white; border-radius: 4px;">
                                f(x) = f(0) + f'(0)x + f''(0)xÂ²/2! + f'''(0)xÂ³/3! + ...
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 8px;">
                                x=0ã§ã®é–¢æ•°ã®å€¤ã¨å¾®åˆ†ä¿‚æ•°ã‹ã‚‰ã€å¤šé …å¼ã‚’æ§‹æˆã—ã¾ã™
                            </p>
                        </div>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px; margin-top: 10px;">
                            <p style="font-weight: 600; margin-bottom: 8px; color: #6a5acd;">ã“ã®ã‚²ãƒ¼ãƒ ã§ã®å±•é–‹çµæœ:</p>
                            <p>sin(x) â†’ <strong>x âˆ’ xÂ³/6 + ...</strong></p>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-left: 16px;">â‰ˆ x (1æ¬¡è¿‘ä¼¼)</p>
                            <p style="margin-top: 8px;">cos(x) â†’ <strong>1 âˆ’ xÂ²/2 + xâ´/24 âˆ’ ...</strong></p>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-left: 16px;">â‰ˆ 1 âˆ’ (1/2)xÂ² (2æ¬¡è¿‘ä¼¼)</p>
                            <p style="margin-top: 8px;">âˆ’sin(x) â†’ <strong>âˆ’x + xÂ³/6 âˆ’ ...</strong></p>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-left: 16px;">â‰ˆ âˆ’x (1æ¬¡è¿‘ä¼¼)</p>
                            <p style="margin-top: 8px;">âˆ’cos(x) â†’ <strong>âˆ’1 + xÂ²/2 âˆ’ xâ´/24 + ...</strong></p>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-left: 16px;">â‰ˆ âˆ’1 + (1/2)xÂ² (2æ¬¡è¿‘ä¼¼)</p>
                            <p style="margin-top: 8px;">e<sup>x</sup> â†’ <strong>1 + x + xÂ²/2 + xÂ³/6 + ...</strong></p>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-left: 16px;">â‰ˆ 1 + x (1æ¬¡è¿‘ä¼¼)</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ”„ åˆæˆæ–¹æ³•</h3>
                        <p>å¾®åˆ†Lv1 ã‚’ <strong>2æšåˆæˆ</strong> ã™ã‚‹ã¨ã€å¾®åˆ†Lv2ï¼ˆãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³å±•é–‹ï¼‰ã«ãªã‚Šã¾ã™ã€‚</p>
                    </div>
                    ` : `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ¯ åŠ¹æœ</h3>
                        <p><strong>å¤šé …å¼:</strong> ax<sup>n</sup> â†’ n Ã— a Ã— x<sup>nâˆ’1</sup></p>
                        <p style="margin-top: 8px;"><strong>ä¸‰è§’é–¢æ•°ã®å¾®åˆ†ã‚µã‚¤ã‚¯ãƒ«:</strong></p>
                        <div style="background: var(--bg-primary); padding: 12px; border-radius: 6px; margin-top: 8px; text-align: center; line-height: 2;">
                            <p>sin(x) â†’<strong> cos(x)</strong></p>
                            <p>cos(x) â†’<strong> âˆ’sin(x)</strong></p>
                            <p>âˆ’sin(x) â†’<strong> âˆ’cos(x)</strong></p>
                            <p>âˆ’cos(x) â†’<strong> sin(x)</strong>ï¼ˆå…ƒã«æˆ»ã‚‹ï¼ï¼‰</p>
                        </div>
                        <p style="margin-top: 8px;"><strong>e<sup>x</sup>:</strong> å¾®åˆ†ã—ã¦ã‚‚ e<sup>x</sup>ï¼ˆå¤‰åŒ–ãªã—ï¼‰</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨ä¾‹</h3>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px;">
                            <p><strong>ä¾‹1:</strong> xÂ² ã‚’å¾®åˆ† â†’ 2x</p>
                            <p style="margin-top: 8px;"><strong>ä¾‹2:</strong> 3xÂ³ ã‚’å¾®åˆ† â†’ 9xÂ²</p>
                            <p style="margin-top: 8px;"><strong>ä¾‹3:</strong> sin(x) ã‚’å¾®åˆ† â†’ cos(x)</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ”„ åˆæˆ</h3>
                        <p>2æšåˆæˆã™ã‚‹ã¨<strong>ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³å±•é–‹</strong>ã«ãªã‚Šã¾ã™ã€‚è©³ç´°ã¯ãƒ¬ãƒ™ãƒ«2ã§ç¢ºèªã§ãã¾ã™ã€‚</p>
                    </div>
                    `}
                `;
            } else if (card.type === 'integral') {
                const isLv2 = card.level >= 2;
                html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ“ åŸºæœ¬èª¬æ˜</h3>
                        <p>ç©åˆ†ã¯å¾®åˆ†ã®é€†æ“ä½œã§ã™ã€‚é€šå¸¸ã¯é–¢æ•°ã®æ¬¡æ•°ã‚’1ã¤ä¸Šã’ã¾ã™ã€‚</p>
                        ${isLv2 ? `<p style="margin-top: 12px; padding: 12px; background: rgba(106,90,205,0.12); border-left: 4px solid #6a5acd; border-radius: 4px;">
                            <strong style="color: #6a5acd;">â­ ãƒ¬ãƒ™ãƒ«2ã«ãªã‚‹ã¨ã€Œç‰¹æ®Šç©åˆ†ã€ã«ãªã‚Šã¾ã™ï¼</strong><br>
                            ä¸‰è§’é–¢æ•°ã‚„æŒ‡æ•°é–¢æ•°ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                        </p>` : ''}
                    </div>
                    ${isLv2 ? `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #6a5acd; margin-bottom: 10px;">ğŸŒŸ ç‰¹æ®Šç©åˆ†ã¨ã¯ï¼Ÿ</h3>
                        <p style="margin-bottom: 10px;">ä¸‰è§’é–¢æ•°ã‚„æŒ‡æ•°é–¢æ•°ã®åå°é–¢æ•°ï¼ˆé€†æ“ä½œï¼‰ã‚’æ±‚ã‚ã¾ã™ã€‚å¾®åˆ†ã®é€†ãªã®ã§ã€ã‚µã‚¤ã‚¯ãƒ«ãŒé€†ã«ãªã‚Šã¾ã™ã€‚</p>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px; margin-top: 10px;">
                            <p style="font-weight: 600; margin-bottom: 8px; color: #6a5acd;">ä¸‰è§’é–¢æ•°ã®ç©åˆ†ã‚µã‚¤ã‚¯ãƒ«:</p>
                            <div style="text-align: center; line-height: 2;">
                                <p>sin(x) â†’<strong> âˆ’cos(x)</strong></p>
                                <p>cos(x) â†’<strong> sin(x)</strong></p>
                                <p>âˆ’sin(x) â†’<strong> cos(x)</strong></p>
                                <p>âˆ’cos(x) â†’<strong> âˆ’sin(x)</strong></p>
                            </div>
                            <p style="margin-top: 10px;"><strong>e<sup>x</sup></strong> ã®ç©åˆ†ã‚‚ <strong>e<sup>x</sup></strong>ï¼ˆå¤‰åŒ–ãªã—ï¼‰</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ”„ åˆæˆæ–¹æ³•</h3>
                        <p>ç©åˆ†Lv1 ã‚’ <strong>2æšåˆæˆ</strong> ã™ã‚‹ã¨ã€ç‰¹æ®Šç©åˆ†ã«ãªã‚Šã¾ã™ã€‚</p>
                    </div>
                    ` : `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ¯ åŠ¹æœ</h3>
                        <p><strong>f(x) â†’ âˆ«f(x)dx</strong></p>
                        <p>ax<sup>n</sup> â†’ (a/(n+1)) Ã— x<sup>n+1</sup></p>
                        <p style="margin-top: 8px; color: var(--text-secondary); font-size: 0.9rem;">â€» Lv1ã§ã¯é€šå¸¸ã®å¤šé …å¼ã®ã¿å¯¾å¿œã€‚ä¸‰è§’é–¢æ•°ã«ã¯åŠ¹ãã¾ã›ã‚“ã€‚</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨ä¾‹</h3>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px;">
                            <p><strong>ä¾‹1:</strong> 2x ã‚’ç©åˆ† â†’ xÂ²</p>
                            <p style="margin-top: 8px;"><strong>ä¾‹2:</strong> 6x ã‚’ç©åˆ† â†’ 3xÂ²</p>
                            <p style="margin-top: 8px;"><strong>ä¾‹3:</strong> xÂ² ã‚’ç©åˆ† â†’ (1/3)xÂ³</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ”„ åˆæˆ</h3>
                        <p>2æšåˆæˆã™ã‚‹ã¨<strong>ç‰¹æ®Šç©åˆ†</strong>ã«ãªã‚Šã¾ã™ã€‚è©³ç´°ã¯ãƒ¬ãƒ™ãƒ«2ã§ç¢ºèªã§ãã¾ã™ã€‚</p>
                    </div>
                    `}
                `;
            } else if (card.type === 'multiply') {
                const multiplier = Math.pow(2, card.level);
                html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ“ åŸºæœ¬èª¬æ˜</h3>
                        <p>é–¢æ•°å…¨ä½“ã‚’å®šæ•°å€ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã§ã™ã€‚ä¿‚æ•°ã‚’èª¿æ•´ã§ãã¾ã™ã€‚</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ¯ åŠ¹æœ</h3>
                        <p><strong>f(x) â†’ ${multiplier} Ã— f(x)</strong></p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨ä¾‹</h3>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px;">
                            <p><strong>ä¾‹1:</strong> xÂ² ã«ä½¿ç”¨</p>
                            <p>â†’ ${multiplier}xÂ²</p>
                            <p style="margin-top: 10px;"><strong>ä¾‹2:</strong> 3x ã«ä½¿ç”¨</p>
                            <p>â†’ ${multiplier * 3}x</p>
                        </div>
                    </div>
                    <div>
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ”„ åˆæˆ</h3>
                        <p>ãƒ¬ãƒ™ãƒ«${card.level} Ã— 2 â†’ ãƒ¬ãƒ™ãƒ«${card.level + 1} (Ã—${multiplier * 2}ã‚«ãƒ¼ãƒ‰)</p>
                    </div>
                `;
            } else if (card.type === 'sinify') {
                html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ“ åŸºæœ¬èª¬æ˜</h3>
                        <p>ä¸‰è§’é–¢æ•°ã®sinï¼ˆã‚µã‚¤ãƒ³ï¼‰ã«å¤‰æ›ã—ã¾ã™ã€‚-1ã‹ã‚‰1ã®é–“ã‚’æ³¢æ‰“ã¤é–¢æ•°ã§ã™ã€‚</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ¯ é‡è¦ãªå€¤</h3>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px;">
                            <p>sin(0) = 0</p>
                            <p>sin(Ï€/2) â‰ˆ 1</p>
                            <p>sin(Ï€) â‰ˆ 0</p>
                            <p>sin(3Ï€/2) â‰ˆ -1</p>
                        </div>
                    </div>
                    <div>
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</h3>
                        <p>sin(x)ã‚’å¾®åˆ†ã™ã‚‹ã¨ cos(x) ã«ãªã‚Šã¾ã™ã€‚</p>
                        <p>cos(x)ã‚’x=0ã§è©•ä¾¡ã™ã‚‹ã¨ 1 ã«ãªã‚Šã¾ã™ã€‚</p>
                    </div>
                `;
            } else if (card.type === 'expify') {
                html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ“ åŸºæœ¬èª¬æ˜</h3>
                        <p>è‡ªç„¶å¯¾æ•°ã®åº•eï¼ˆâ‰ˆ2.718ï¼‰ã‚’ä½¿ã£ãŸæŒ‡æ•°é–¢æ•°ã«å¤‰æ›ã—ã¾ã™ã€‚</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ¯ é‡è¦ãªå€¤</h3>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px;">
                            <p>e<sup>0</sup> = 1</p>
                            <p>e<sup>1</sup> â‰ˆ 2.718</p>
                            <p>e<sup>2</sup> â‰ˆ 7.389</p>
                        </div>
                    </div>
                    <div>
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ’¡ ç‰¹å¾´</h3>
                        <p>e<sup>x</sup>ã‚’å¾®åˆ†ã—ã¦ã‚‚ e<sup>x</sup> ã®ã¾ã¾å¤‰ã‚ã‚Šã¾ã›ã‚“ï¼</p>
                        <p>å¯¾æ•°åŒ–ã‚«ãƒ¼ãƒ‰ã§xã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
                    </div>
                `;
            } else if (card.type === 'logify') {
                html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px; font-size: 1.1rem;">ğŸ“ åŸºæœ¬èª¬æ˜</h3>
                        <p style="font-size: 1rem; line-height: 1.8;">è‡ªç„¶å¯¾æ•°ï¼ˆlog<sub>e</sub>ï¼‰ã«å¤‰æ›ã—ã¾ã™ã€‚æŒ‡æ•°é–¢æ•°ã®é€†æ“ä½œã§ã™ã€‚</p>
                        <p style="margin-top: 12px; padding: 12px; background: rgba(217, 119, 87, 0.1); border-left: 4px solid var(--accent-main); border-radius: 4px; font-size: 1rem;">
                            <strong>ğŸ’¡ ã‚ã‹ã‚Šã‚„ã™ãè¨€ã†ã¨ï¼š</strong><br>
                            ã€Œeã‚’ä½•ä¹—ã—ãŸã‚‰ã“ã®æ•°ã«ãªã‚‹ã‹ï¼Ÿã€ã‚’æ±‚ã‚ã¾ã™
                        </p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px; font-size: 1.1rem;">ğŸ¯ é‡è¦ãªå€¤</h3>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px; font-size: 1rem; line-height: 2;">
                            <p><strong>log<sub>e</sub>(1) = 0</strong></p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 20px;">â†’ eã‚’0ä¹—ã™ã‚‹ã¨1</p>
                            <p style="margin-top: 8px;"><strong>log<sub>e</sub>(e) = 1</strong></p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 20px;">â†’ eã‚’1ä¹—ã™ã‚‹ã¨e</p>
                            <p style="margin-top: 8px;"><strong>log<sub>e</sub>(eÂ²) = 2</strong></p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 20px;">â†’ eã‚’2ä¹—ã™ã‚‹ã¨eÂ²</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px; font-size: 1.1rem;">ğŸ’¡ ä½¿ã„æ–¹ã®ã‚³ãƒ„</h3>
                        <div style="background: rgba(139, 115, 85, 0.1); padding: 15px; border-radius: 6px; font-size: 1rem;">
                            <p><strong>e<sup>x</sup>ã«å¯¾æ•°åŒ–ã‚’ä½¿ã†ã¨ x ã«æˆ»ã‚Šã¾ã™</strong></p>
                            <p style="margin-top: 8px;">log<sub>e</sub>(e<sup>x</sup>) = x</p>
                            <p style="margin-top: 12px; color: var(--text-secondary);">
                                ä¾‹: e<sup>x</sup> â†’ log<sub>e</sub>åŒ– â†’ xï¼ˆxã«æˆ»ã‚‹ï¼ï¼‰
                            </p>
                        </div>
                    </div>
                `;
            } else if (card.type === 'limit_zero') {
                html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px; font-size: 1.1rem;">ğŸ“ åŸºæœ¬èª¬æ˜</h3>
                        <p style="font-size: 1rem; line-height: 1.8;">æ¥µé™ã‚«ãƒ¼ãƒ‰ã¯é–¢æ•°ãŒxâ†’0ã«è¿‘ã¥ãã¨ãã®å€¤ã‚’æ±‚ã‚ã¾ã™ã€‚</p>
                        <p style="margin-top: 12px; padding: 12px; background: rgba(212, 184, 184, 0.15); border-left: 4px solid var(--card-limit); border-radius: 4px; font-size: 1rem;">
                            <strong style="color: #b86868;">ğŸ’¡ æ¥µé™ã¨ã¯ï¼š</strong><br>
                            xãŒ0ã«é™ã‚Šãªãè¿‘ã¥ã„ãŸã¨ãã®é–¢æ•°ã®æŒ¯ã‚‹èˆã„ã‚’è¦‹ã‚‹å¼·åŠ›ãªæ•°å­¦ãƒ„ãƒ¼ãƒ«ã§ã™
                        </p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px; font-size: 1.1rem;">ğŸ¯ åŠ¹æœ</h3>
                        <p><strong>lim<sub>xâ†’0</sub> f(x)</strong></p>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px; margin-top: 10px; font-size: 1rem; line-height: 2;">
                            <p><strong>å¤šé …å¼ã®å ´åˆï¼š</strong></p>
                            <p style="margin-left: 20px;">ax<sup>n</sup> + c â†’ cï¼ˆå®šæ•°é …ã®ã¿æ®‹ã‚‹ï¼‰</p>
                            <p style="margin-top: 12px;"><strong>ç‰¹æ®Šé–¢æ•°ã®å ´åˆï¼š</strong></p>
                            <p style="margin-left: 20px;">sin(x), cos(x), e<sup>x</sup> ãªã© â†’ 0</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #b86868; margin-bottom: 10px; font-size: 1.1rem;">ğŸŒŸ æœ‰åãªæ¥µé™</h3>
                        <div style="background: rgba(212, 184, 184, 0.1); padding: 15px; border-radius: 6px; font-size: 1rem;">
                            <p style="font-weight: 600; margin-bottom: 10px;">ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³å±•é–‹ã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨å¼·åŠ›ï¼š</p>
                            <div style="margin-left: 15px; line-height: 2.2;">
                                <p>sin(x) â†’<span style="color: #6a5acd;"> [ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³]</span> â†’ x â†’<span style="color: #b86868;"> [æ¥µé™]</span> â†’ 0</p>
                                <p>cos(x) â†’<span style="color: #6a5acd;"> [ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³]</span> â†’ 1 âˆ’ (1/2)xÂ² â†’<span style="color: #b86868;"> [æ¥µé™]</span> â†’ 1</p>
                                <p>e<sup>x</sup> â†’<span style="color: #6a5acd;"> [ãƒã‚¯ãƒ­ãƒ¼ãƒªãƒ³]</span> â†’ 1 + x â†’<span style="color: #b86868;"> [æ¥µé™]</span> â†’ 1</p>
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px; font-size: 1.1rem;">ğŸ’¡ ä½¿ç”¨ä¾‹</h3>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px; font-size: 1rem;">
                            <p><strong>ä¾‹1:</strong> f(x) = 3xÂ² + 5 ã«ä½¿ç”¨</p>
                            <p style="margin-left: 20px;">â†’ lim<sub>xâ†’0</sub> (3xÂ² + 5) = 5</p>
                            <p style="margin-top: 10px;"><strong>ä¾‹2:</strong> f(x) = 2x âˆ’ 3 ã«ä½¿ç”¨</p>
                            <p style="margin-left: 20px;">â†’ lim<sub>xâ†’0</sub> (2x âˆ’ 3) = âˆ’3</p>
                            <p style="margin-top: 10px;"><strong>ä¾‹3:</strong> f(x) = x ã«ä½¿ç”¨</p>
                            <p style="margin-left: 20px;">â†’ lim<sub>xâ†’0</sub> x = 0</p>
                        </div>
                    </div>
                `;
            } else if (card.type === 'inverse') {
                html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ“ åŸºæœ¬èª¬æ˜</h3>
                        <p>é–¢æ•°ã®é€†æ•°ï¼ˆ1Ã·é–¢æ•°ï¼‰ã‚’å–ã‚Šã¾ã™ã€‚</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ¯ åŠ¹æœ</h3>
                        <p><strong>ãƒ¬ãƒ™ãƒ«${card.level}:</strong> ${card.level % 2 === 1 ? 'f(x) â†’ 1/f(x)' : 'f(x) â†’ f(x) (ç„¡åŠ¹åŒ–)'}</p>
                    </div>
                    <div>
                        <h3 style="color: var(--accent-main); margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨ä¾‹</h3>
                        <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px;">
                            <p><strong>ä¾‹:</strong> f(x) = 2 ã«ä½¿ç”¨</p>
                            <p>â†’ 1/2 = 0.5</p>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠã«æˆ»ã‚‹
        function backToStageSelect() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('stage-select').style.display = 'flex';
            
            // è¨˜éŒ²ã‚’æ›´æ–°
            updateStageRecordDisplay();
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            gameState = {
                currentStage: 1,
                enemyFunction: { coefficient: 1, exponent: 2, constant: -6 },
                hand: [],
                selectedCardIndex: null,
                mergeMode: false,
                selectedForMerge: [],
                remainingTurns: 5,
                maxTurns: 5,
                newCardIndices: [],
                cardQueue: [],
                cardQueueIndex: 0
            };
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¨˜éŒ²ã‚’è¡¨ç¤º
        window.addEventListener('DOMContentLoaded', () => {
            updateStageRecordDisplay();
        });
    </script>
</body>
</html>
